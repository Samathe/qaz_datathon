<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Индекс качества жизни – Казахстан (прототип)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
  :root {
    --panel-bg: #ffffff;
    --bg: #f9fafb;
    --border: #d1d5db;
    --gridline: rgba(0,160,200,0.15);
    --text-main: #374151;
    --text-dim: #9ca3af;
    --radius-lg: 8px;
    --shadow-card: 0 10px 30px rgba(0,0,0,0.07);
    --shadow-float: 0 20px 60px rgba(0,0,0,0.18);
    --font: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
            "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
    --viz-height: 700px;
    --viz-width: 1400px;
    --header-height: 240px;
    --color-dark: #17173f;
    --color-navy: #212153;
    --color-peach: #f3b77b;

    /* OECD-inspired palette */
    --color-blue: #6BAED6;
    --color-green: #74C476;
    --color-orange: #FD8D3C;
    --color-purple: #9E9AC8;
    --color-red: #E6550D;
    --color-teal: #41B6C4;
    --color-yellow: #FEB24C;
    --color-lavender: #BCBDDC;
    --color-sage: #8C9E8C;
    --color-aqua: #5B8FA8;
    --bg-light: #F7FBFF;
    --grid-line: rgba(91,143,168,0.15);
    --border-light: #D1E0E0;
    --text-primary: #2C3E50;
    --text-secondary: #5B8FA8;
  }

  @keyframes float {
    0% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(5deg); }
    100% { transform: translateY(0px) rotate(0deg); }
  }

  .header {
    position: relative;
    width: 100%;
    height: var(--header-height);
    background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-dark) 100%);
    overflow: hidden;
    margin-bottom: 32px;
  }

  .header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at center, transparent 30%, var(--color-navy) 70%);
    opacity: 0.4;
    animation: rotate 60s linear infinite;
  }

  .header-content {
    position: relative;
    z-index: 1;
    max-width: 1700px;
    margin: 0 auto;
    padding: 40px;
    color: white;
    text-align: center;
  }

    .header-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 20px;
      background: linear-gradient(135deg, white, var(--color-peach));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      line-height: 1.3;
      max-width: 1200px;
    }

    .header-title-main {
      display: block;
      font-size: 38px;
      margin-bottom: 12px;
      font-family: Georgia, 'Times New Roman', serif;
      font-weight: 700;
    }

    .header-title-sub {
      display: block;
      font-size: 24px;
      font-family: Georgia, 'Times New Roman', serif;
      font-weight: 500;
      color: white; /* ensure visible over gradient */
      text-shadow: 0 1px 2px rgba(0,0,0,0.25);
      margin-top: 6px;
      opacity: 0.98;
    }

    .header-subtitle {
      font-size: 18px;
      color: rgba(255,255,255,0.9);
      max-width: 800px;
      line-height: 1.6;
    }

  .geometric-shapes {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .shape {
    position: absolute;
    background: var(--color-peach);
    opacity: 0.1;
    border-radius: 50%;
  }

  .shape-1 {
    width: 300px;
    height: 300px;
    top: -150px;
    left: 10%;
    animation: float 8s infinite ease-in-out;
  }

  .shape-2 {
    width: 200px;
    height: 200px;
    bottom: -100px;
    right: 15%;
    animation: float 12s infinite ease-in-out reverse;
    background: white;
  }

  .shape-3 {
    width: 150px;
    height: 150px;
    top: 20%;
    right: 25%;
    animation: float 10s infinite ease-in-out;
    background: var(--color-peach);
    opacity: 0.2;
  }

    .header-title {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 16px;
      background: linear-gradient(135deg, white, var(--color-peach));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      line-height: 1.1;
      display: inline-block; /* prevent full-width clipping to allow centered subtitle below */
    }

    /* Ensure subtitle isn't clipped by the gradient text of the parent */
    .header-title .header-title-sub {
      background: none !important;
      -webkit-background-clip: initial !important;
      background-clip: initial !important;
      -webkit-text-fill-color: initial !important;
      color: white !important;
    }

  .header-subtitle {
    font-size: 18px;
    color: rgba(255,255,255,0.9);
    max-width: 600px;
    line-height: 1.6;
  }

  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  body {
    margin: 0;
    background: var(--bg-light);
    font-family: var(--font);
    color: var(--text-primary);
    line-height: 1.4;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Make UI and SVG texts black for improved readability */
  .main-area, .sidebar, .controls-panel, .detail-card, .block-label, .slider-head, .slider-desc, select, option {
    color: #000 !important;
  }
  svg text, .stem-label, .score-text {
    fill: #000 !important;
  }

  .content-wrapper {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    justify-content: center;
    width: 100%;
    max-width: 1700px;
    padding: 16px;
    box-sizing: border-box;
    gap: 16px;
  }

  .sidebar {
    width: 280px;
    min-width: 260px;
    max-width: 320px;
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-card);
    box-sizing: border-box;
    padding: 16px 16px 12px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    height: var(--viz-height);
    position: sticky;
    top: 16px;
    flex-shrink: 0;
  }

  .sidebar-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 4px;
  }

  .sidebar-sub {
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 12px;
  }

  .slider-block {
    margin-bottom: 14px;
  }

  .slider-head {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    font-size: 13px;
    line-height: 1.2;
    font-weight: 500;
    color: var(--text-main);
    margin-bottom: 4px;
  }

  .label-container {
    display: inline-block;
  }

  .weight-tooltip {
    display: none;
    position: absolute;
    width: 300px;
    background: #ffffff;
    color: #334155;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: normal;
    line-height: 1.5;
    box-shadow: 0 8px 16px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
    z-index: 1000000;
    border: 1px solid #e5e7eb;
    pointer-events: none;
  }

  .weight-tooltip::before {
    content: "";
    position: absolute;
    left: -6px;
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
    width: 12px;
    height: 12px;
    background: inherit;
    border-left: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
  }

  .label-container:hover .weight-tooltip {
    display: block;
  }

  .slider-head .val {
    font-size: 12px;
    color: var(--text-dim);
    font-weight: 400;
    margin-left: 8px;
  }

  .slider-desc {
    font-size: 11px;
    color: var(--text-dim);
    line-height: 1.4;
    margin-bottom: 4px;
  }

  input[type=range] {
    width: 100%;
  }

  .control-block {
    font-size: 12px;
    color: var(--text-main);
    line-height: 1.4;
    padding: 8px 0;
  }

  .control-block:not(:last-child) {
    border-bottom: 1px solid var(--border);
  }

  .block-label {
    margin-bottom: 6px;
    font-weight: 500;
    font-size: 12px;
    color: var(--text-main);
  }

  .select-wrapper {
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 8px 10px;
    font-size: 12px;
    background: #f9fafb;
    display: flex;
    flex-direction: row;
    align-items: center;
  }

  .controls-panel {
    width: 280px;
    min-width: 260px;
    max-width: 320px;
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-card);
    box-sizing: border-box;
    padding: 16px;
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 16px;
    height: fit-content;
  }

  select {
    width: 100%;
    font-size: 12px;
    color: var(--text-main);
    background: transparent;
    border: none;
    outline: none;
  }

  .main-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    box-sizing: border-box;
    position: relative;
    max-width: var(--viz-width);
    width: 100%;
  }

  #viewTitle {
    margin: 6px 0 12px 0;
    font-size: 16px;
    color: var(--text-main);
    text-align: center;
    width: 100%;
  }

  svg {
    overflow: visible;
    font-family: var(--font);
    width: var(--viz-width);
    height: var(--viz-height);
    display: block;
  }

  .axis-line {
    stroke: var(--gridline);
    stroke-width: 1;
  }

  .stem-label {
    fill: #000000 !important;
    font-size: 22px;
    font-weight: 600;
    text-anchor: middle;
    dominant-baseline: middle;
    pointer-events: none;
    paint-order: stroke;
    stroke: #ffffff;
    stroke-width: 2px;
    stroke-opacity: 0.8;
  }

  .score-text {
    fill: #000000 !important;
    font-size: 20px;
    font-weight: 700;
    text-anchor: middle;
    alignment-baseline: middle;
    pointer-events: none;
    text-shadow: 
      0 0 3px #ffffff,
      0 0 3px #ffffff,
      0 0 3px #ffffff !important;
    paint-order: stroke;
    stroke: #ffffff;
    stroke-width: 3px;
    stroke-opacity: 0.8;
  }

  .flower-group {
    cursor: pointer;
    transition: opacity 0.15s;
  }

  .flower-center {
    transition: all 0.3s ease;
    filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));
  }

  .petal {
    fill-opacity: 0.85;
    stroke: rgba(255, 255, 255, 0.4);
    stroke-width: 0.6px;
    pointer-events: none;
    transition: all 0.2s ease;
  }

  .flower-group:hover .petal {
    fill-opacity: 0.95;
    stroke-width: 1px;
    transform: scale(1.05);
  }

  .flower-group.highlight .petal {
    stroke-width: 1px;
    transform: scale(1.05);
  }

  /* Ensure all text in flowers is black */
  .flower-group text {
    fill: #000000 !important;
    paint-order: stroke;
    stroke: #ffffff;
    stroke-width: 2px;
    stroke-opacity: 0.8;
  }

  .hit-area {
    fill: transparent;
    pointer-events: all;
  }

  .detail-card {
    position: fixed;
    min-width: 340px;
    max-width: 400px;
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 4px;
    box-shadow: var(--shadow-float);
    padding: 16px 20px 16px;
    font-size: 12px;
    color: var(--text-main);
    line-height: 1.4;
    z-index: 9999;
    display: none;
    pointer-events: none;
  }

  .detail-header {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-main);
    margin-bottom: 8px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 4px;
  }

  .scale-row {
    font-size: 10px;
    color: var(--text-main);
    font-family: ui-monospace, SFMono-Regular, Consolas, "Liberation Mono", monospace;
    display: flex;
    justify-content: flex-end;
    column-gap: 3px;
    margin-bottom: 8px;
  }

  .bar-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    font-size: 12px;
    line-height: 1.2;
  }

  .bar-label {
    flex: 1;
    padding-right: 6px;
    white-space: nowrap;
  }

  .bar-wrapper {
    display: flex;
    flex-direction: row;
    align-items: center;
    column-gap: 6px;
    min-width: 160px;
  }

  .bar-track {
    width: 120px;
    height: 10px;
    border-radius: 2px;
    background: #eee;
    position: relative;
    flex-shrink: 0;
  }

  .bar-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 10px;
    border-radius: 2px;
  }

  .bar-value {
    font-size: 11px;
    color: var(--text-main);
    min-width: 24px;
    text-align: left;
    font-family: ui-monospace, SFMono-Regular, Consolas, "Liberation Mono", monospace;
  }

  .detail-extra {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 10px;
    line-height: 1.4;
    border-top: 1px solid var(--border);
    padding-top: 8px;
  }

  /* Trend panel styles */
  .trend-panel {
    width: 100%;
    max-width: 1400px;
    margin: 40px auto;
    padding: 20px;
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-float);
    position: relative;
  }

  .trend-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
  }

  .trend-header h3 {
    margin: 0;
    color: var(--text-main);
    font-size: 18px;
  }

  #closeTrendPanel {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--text-dim);
    padding: 5px;
  }

  #closeTrendPanel:hover { color: var(--text-main); }

  .trend-button {
    width: 100%;
    padding: 10px;
    background: var(--color-blue);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s ease;
  }

  .trend-button:hover { background: #5a9bc8; }

  .trend-line { 
    fill: none; 
    stroke-width: 3.5px; 
    stroke-linejoin: round; 
    stroke-linecap: round;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
  }
  .trend-dot { 
    cursor: pointer; 
    transition: all 0.3s ease;
    r: 5;
    stroke: #fff;
    stroke-width: 2;
    filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));
  }
  .trend-dot:hover { 
    r: 7; 
    stroke-width: 3; 
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }
  .trend-legend { 
    font-size: 14px; 
    cursor: pointer; 
    transition: opacity 0.2s ease;
    font-weight: 500;
  }
  .trend-legend:hover { opacity: 0.8; }
  .trend-legend.hidden { opacity: 0.3; }
  .trend-axis { 
    font-size: 14px; 
    color: var(--text-main);
    font-weight: 500;
  }
  .trend-grid { 
    stroke: var(--gridline); 
    stroke-width: 1.5; 
    stroke-dasharray: 4,4; 
  }
  .axis-label { 
    font-size: 16px; 
    fill: var(--text-main); 
    font-weight: 600;
  }

  .trend-tooltip {
    position: absolute; padding: 8px 12px; background: rgba(255,255,255,0.95);
    border: 1px solid var(--border); border-radius: 4px; pointer-events: none; font-size:12px;
    box-shadow: var(--shadow-card); z-index:1000;
  }

  /* Ranking panel styles */
  .ranking-card {
    position: fixed;
    min-width: 400px;
    max-width: 500px;
    max-height: 600px;
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: var(--shadow-float);
    padding: 16px;
    font-size: 12px;
    color: var(--text-main);
    z-index: 10000;
    display: none;
    overflow-y: auto;
  }

  .ranking-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  .ranking-header h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
  }

  #closeRankingCard {
    background: none;
    border: none;
    font-size: 16px;
    cursor: pointer;
    color: var(--text-dim);
    padding: 2px;
  }

  .ranking-year-selector {
    margin-bottom: 12px;
  }

  .ranking-year-selector select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: white;
  }

  .ranking-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .ranking-row {
    display: grid;
    grid-template-columns: 40px 1fr 60px 50px;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 4px;
    align-items: center;
    transition: background-color 0.2s ease;
  }

  .ranking-row:hover {
    background-color: #f8f9fa;
  }

  .ranking-header-row {
    font-weight: 600;
    background-color: #f1f5f9;
    border-radius: 4px;
  }

  .rank-position {
    font-weight: 600;
    text-align: center;
    color: var(--text-main);
  }

  .rank-name {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .rank-score {
    text-align: right;
    font-family: ui-monospace, SFMono-Regular, Consolas, "Liberation Mono", monospace;
    font-weight: 600;
  }

  .rank-change {
    text-align: center;
    font-family: ui-monospace, SFMono-Regular, Consolas, "Liberation Mono", monospace;
    font-size: 11px;
  }

  .rank-change.positive {
    color: #10b981;
    font-weight: 600;
  }

  .rank-change.negative {
    color: #ef4444;
    font-weight: 600;
  }

  /* Adaptive styles for mobile devices */
  @media (max-width: 768px) {
    .ranking-card {
      min-width: 300px;
      max-width: 90vw;
      left: 50% !important;
      transform: translateX(-50%);
      top: 20px !important;
    }
  }
</style>
</head>
<body>
<header class="header">
  <div class="geometric-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>
  <div class="header-content">
    <h1 class="header-title">
      <span class="header-title-main">Многомерная методологическая модель оценки благополучия в Казахстане</span>
      <span class="header-title-sub">региональный, территориальный, гендерный и возрастной композитный индекс качества жизни</span>
    </h1>

  </div>
</header>
<div class="content-wrapper">
  <aside class="sidebar">
    <div class="sidebar-title">Создайте свой Индекс Качества Жизни</div>
    <div class="sidebar-sub">
      Лепестки = показатели качества жизни (жильё, доход, здоровье...).
      Высота цветка = итоговый индекс, учитывающий ваши веса.
    </div>
    <div id="sliders"></div>
  </aside>

  <section class="main-area">
    <h2 id="viewTitle"></h2>
    <svg id="viz"></svg>
    <div class="detail-card" id="detailCard"></div>
  </section>
  <aside class="controls-panel">
    <div class="controls-title">Настройки отображения</div>
    
    <div class="control-block">
      <div class="block-label">Сравнивать по (ось X):</div>
      <div class="select-wrapper">
        <select id="groupSelect">
          <option value="Region">Регион (область / город)</option>
          <option value="AgeGroup">Возрастная группа</option>
          <option value="Gender">Гендер</option>
          <option value="SettlementType">Тип поселения</option>
        </select>
      </div>
    </div>

    <div class="control-block">
      <div class="block-label">Выберите год:</div>
      <div class="select-wrapper">
        <select id="yearSelect"></select>
      </div>
    </div>

    <div class="control-block">
      <div class="block-label">Сортировать по:</div>
      <div class="select-wrapper">
        <select id="sortSelect">
          <option value="name">Название (А–Я)</option>
          <option value="score_desc">Индекс (высокий → низкий)</option>
          <option value="score_asc">Индекс (низкий → высокий)</option>
        </select>
      </div>
    </div>

    <div class="control-block">
      <div class="block-label">Показать:</div>
      <div class="select-wrapper">
        <select id="topSelect">
          <option value="all">Все</option>
          <option value="1">Top 1</option>
          <option value="2">Top 2</option>
          <option value="3">Top 3</option>
          <option value="4">Top 4</option>
          <option value="5">Top 5</option>
          <option value="10">Top 10</option>
        </select>
      </div>
    </div>
    <div class="control-block">
      <div class="block-label">Анализ тенденций:</div>
      <button id="showTrendPanel" class="trend-button">Показать динамику по годам</button>
    </div>
  </aside>
</div>

<!-- Trend panel (hidden by default) placed below main content -->
<section class="trend-panel" id="trendPanel" style="display: none;">
  <div class="trend-header">
    <h3>Динамика индекса качества жизни по годам</h3>
    <div class="trend-controls">
      <button id="closeTrendPanel">✕</button>
    </div>
  </div>
  <svg id="trendViz" width="1400" height="400"></svg>
</section>

<script>
const DIMENSIONS = [
  { key: "food_insecurity", label: "Food Insecurity" },
  { key: "missed_payments", label: "Missed Payments Rate" },
  { key: "internet_access", label: "Internet Access Rate" },
  { key: "unmet_healthcare", label: "Unmet Healthcare Need" },
  { key: "clothing_afford", label: "Basic Clothing Affordability" },
  { key: "internet_use", label: "Regular Internet Use" },
  { key: "social_afford", label: "Social Affordability" },
  { key: "holiday_afford", label: "Holiday Affordability" },
  { key: "welfare_trend", label: "Welfare Trend Distribution" },
  { key: "health_index", label: "Health Index" },
  { key: "housing_quality", label: "Housing Quality Index" },
  { key: "leisure_time", label: "Leisure Time Index" },
  { key: "life_index", label: "Life Index" },
  { key: "living_condition", label: "Living Condition Index" },
  { key: "prof_wellbeing", label: "Professional Wellbeing Index" },
  { key: "financial_situation", label: "Financial Situation Index" }
];

let weights = {};
DIMENSIONS.forEach(dim => { weights[dim.key] = 5; });

let DATASETS = {};
let currentGrouping = "Region";
let CURRENT_DATA = [];
let selectedYear = null;

const svg = d3.select("#viz");
const WIDTH = 1400;
const HEIGHT = 700;
const PAD_TOP = 40;
const PAD_BOTTOM = 80;
const PAD_LEFT = 20;
const PAD_RIGHT = 20;

// Create color scales for the flower center and petals
const colorScaleYellow = d3.scaleLinear()
  .domain([0, 5, 10])
  .range(['#FFF9C4', '#FFEE58', '#FDD835']) // Softer yellows for better contrast
  .interpolate(d3.interpolateRgb);

const petalGradient = (id) => `url(#petalGradient${id})`;

// Return color from OECD-inspired color palette
function colorForDim(i) {
  const oecdColors = [
    "#6BAED6",  // Blue
    "#74C476",  // Green  
    "#FD8D3C",  // Orange
    "#9E9AC8",  // Purple
    "#E6550D",  // Red
    "#41B6C4",  // Teal
    "#FEB24C",  // Yellow
    "#BCBDDC",  // Lavender
    "#8C9E8C",  // Sage
    "#DE9ED6",  // Pink
    "#5B8FA8"   // Aqua
  ];
  return oecdColors[i % oecdColors.length];
}

// ---------- Trend panel JS (shows multi-line trends per selected grouping) ----------
// Add this function to link flowers with trend-panel
function highlightTrendLine(itemName) {
  if (!trendPanelVisible) return;
  
  const trendSvg = d3.select('#trendViz');
  // Reset all highlights
  trendSvg.selectAll('.trend-line').style('opacity', 0.3);
  trendSvg.selectAll('.trend-dot').style('opacity', 0.3);
  trendSvg.selectAll('.trend-legend').classed('hidden', true);
  
  // Highlight corresponding line
  const targetLine = trendSvg.selectAll(`[data-item="${itemName}"]`);
  const targetDots = trendSvg.selectAll('.trend-dot').filter(d => d.itemName === itemName);
  const targetLegend = trendSvg.selectAll('.trend-legend').filter(d => d.name === itemName);
  
  if (!targetLine.empty()) {
    targetLine.style('opacity', 1).style('stroke-width', 4);
    targetDots.style('opacity', 1).attr('r', 5);
    targetLegend.classed('hidden', false);
    
    // Scroll to trend panel
    document.getElementById('trendPanel').scrollIntoView({ behavior: 'smooth' });
  }
}

let trendPanelVisible = false;

function initializeTrendPanel() {
  const showButton = document.getElementById('showTrendPanel');
  const closeButton = document.getElementById('closeTrendPanel');
  const trendPanel = document.getElementById('trendPanel');
  if (!trendPanel) return;

  if (showButton) {
    showButton.addEventListener('click', function() {
      trendPanelVisible = true;
      trendPanel.style.display = 'block';
      updateTrendViz();
      trendPanel.scrollIntoView({ behavior: 'smooth' });
    });
  }

  if (closeButton) {
    closeButton.addEventListener('click', function() {
      trendPanelVisible = false;
      trendPanel.style.display = 'none';
    });
  }

  // Also update when grouping changes while visible
  const groupSelect = document.getElementById('groupSelect');
  if (groupSelect) {
    groupSelect.addEventListener('change', function() {
      if (trendPanelVisible) setTimeout(updateTrendViz, 50);
    });
  }
}

function calculateTrendData() {
  const years = ['2020','2021','2022','2023','2024'];
  const trendData = [];
  const grouping = currentGrouping || 'Region';

  const allItems = new Set();
  years.forEach(year => {
    const yearData = getYearData(grouping, year) || [];
    yearData.forEach(item => allItems.add(item.name));
  });

  allItems.forEach(itemName => {
    const itemTrend = { name: itemName, values: [], color: getColorForItem(itemName) };
    years.forEach(year => {
      const yearData = getYearData(grouping, year) || [];
      const itemData = yearData.find(it => it.name === itemName);
      if (itemData) {
        itemTrend.values.push({ year: year, value: overallScore(itemData), rawData: itemData });
      } else {
        itemTrend.values.push({ year: year, value: null, rawData: null });
      }
    });
    const valid = itemTrend.values.filter(v => v.value !== null);
    if (valid.length >= 2) trendData.push(itemTrend);
  });

  return trendData;
}

function getColorForItem(itemName) {
  // Высококонтрастная палитра цветов
  const colors = [
    '#2E3192', // Темно-синий
    '#D62828', // Красный
    '#107C10', // Зеленый
    '#7B1FA2', // Фиолетовый
    '#E65100', // Оранжевый
    '#006064', // Сине-зеленый
    '#C2185B', // Малиновый
    '#1565C0', // Яркий синий
    '#33691E', // Темно-зеленый
    '#6A1B9A', // Насыщенный фиолетовый
    '#283593', // Индиго
    '#004D40', // Темный сине-зеленый
    '#B71C1C', // Темно-красный
    '#1B5E20', // Насыщенный зеленый
    '#4A148C'  // Темно-фиолетовый
  ];
  
  let hash = 0;
  for (let i = 0; i < itemName.length; i++) {
    hash = itemName.charCodeAt(i) + ((hash << 5) - hash);
  }
  return colors[Math.abs(hash) % colors.length];
}

function updateTrendViz() {
  if (!trendPanelVisible) return;
  let trendData = calculateTrendData();
  const svg = d3.select('#trendViz');
  if (svg.empty()) return;
  svg.selectAll('*').remove();

  // Apply top N filter if selected
  const topSelect = document.getElementById('topSelect');
  if (topSelect && topSelect.value !== 'all') {
    const topN = parseInt(topSelect.value);
    // Get the latest year data to determine top N
    const latestYear = '2024'; // or get dynamically from your data
    const latestData = {};
    trendData.forEach(item => {
      const latestValue = item.values.find(v => v.year === latestYear)?.value;
      if (latestValue !== undefined) {
        latestData[item.name] = latestValue;
      }
    });
    
    // Sort by latest year values and get top N names
    const topNames = Object.entries(latestData)
      .sort((a, b) => b[1] - a[1])
      .slice(0, topN)
      .map(([name]) => name);
    
    // Filter trend data to only include top N
    trendData = trendData.filter(item => topNames.includes(item.name));
  }

  if (trendData.length === 0) {
    svg.append('text').attr('x',700).attr('y',200).attr('text-anchor','middle').attr('fill','#9ca3af').text('Недостаточно данных для отображения трендов');
    return;
  }

  const margin = { top: 40, right: 200, bottom: 50, left: 60 };
  const width = +svg.attr('width') - margin.left - margin.right;
  const height = +svg.attr('height') - margin.top - margin.bottom;
  const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);
  const years = ['2020','2021','2022','2023','2024'];

  const xScale = d3.scalePoint().domain(years).range([0, width]).padding(0.5);
  let globalMin = Infinity, globalMax = -Infinity;
  trendData.forEach(item => item.values.forEach(d => { if (d.value !== null) { globalMin = Math.min(globalMin, d.value); globalMax = Math.max(globalMax, d.value); } }));
  if (!isFinite(globalMin)) { globalMin = 0; globalMax = 10; }
  const yPadding = (globalMax - globalMin) * 0.1 || 1;
  const yScale = d3.scaleLinear().domain([Math.max(0, globalMin - yPadding), Math.min(10, globalMax + yPadding)]).range([height,0]).nice();

  const yTicks = yScale.ticks(6);
  g.selectAll('.trend-grid').data(yTicks).enter().append('line').attr('class','trend-grid').attr('x1',0).attr('x2',width).attr('y1',d=>yScale(d)).attr('y2',d=>yScale(d));

  const xAxis = d3.axisBottom(xScale);
  const yAxis = d3.axisLeft(yScale);
  g.append('g').attr('class','trend-axis').attr('transform',`translate(0,${height})`).call(xAxis);
  g.append('g').attr('class','trend-axis').call(yAxis);

  g.append('text').attr('class','axis-label').attr('transform',`translate(${width/2},${height+40})`).style('text-anchor','middle').text('Год');
  g.append('text').attr('class','axis-label').attr('transform','rotate(-90)').attr('y',-40).attr('x',-height/2).style('text-anchor','middle').text('Индекс качества жизни');

  const line = d3.line().x(d=>xScale(d.year)).y(d=>yScale(d.value)).defined(d=>d.value!==null).curve(d3.curveMonotoneX);

  const lines = g.selectAll('.trend-line-group').data(trendData).enter().append('g');
  lines.append('path').attr('class','trend-line').attr('d',d=>line(d.values)).attr('stroke',d=>d.color).attr('fill','none').attr('data-item',d=>d.name).style('opacity',1);

  const tooltip = d3.select('body').append('div').attr('class','trend-tooltip').style('opacity',0);

  lines.selectAll('.trend-dot').data(d=>d.values.map(v=>({...v,itemName:d.name,color:d.color})).filter(v=>v.value!==null)).enter().append('circle').attr('class','trend-dot')
    .attr('cx',d=>xScale(d.year)).attr('cy',d=>yScale(d.value)).attr('r',4).attr('fill',d=>d.color).attr('stroke','#fff').attr('stroke-width',2)
    .on('mouseover',function(event,d){ tooltip.transition().duration(200).style('opacity',0.95); tooltip.html(`<div style="font-weight:600;margin-bottom:4px;">${d.itemName} - ${d.year}</div><div>Индекс: <strong>${d.value.toFixed(2)}</strong></div>${d.rawData?`<div style="margin-top:4px;font-size:11px;color:#666;">Нажмите для деталей</div>`:''}`).style('left',(event.pageX+10)+'px').style('top',(event.pageY-28)+'px'); d3.select(this).attr('r',6).attr('stroke-width',3); })
    .on('mouseout',function(){ tooltip.transition().duration(500).style('opacity',0); d3.select(this).attr('r',4).attr('stroke-width',2); })
    .on('click',function(event,d){ 
      if (d.rawData && typeof window.showDetailCard === 'function') {
        window.showDetailCard(d.rawData, event.clientX, event.clientY, DIMENSIONS, colorForDim);
      }
    });

  const legend = svg.append('g').attr('transform',`translate(${width + margin.left + 20}, ${margin.top})`);
  const legendItems = legend.selectAll('.trend-legend').data(trendData).enter().append('g').attr('class','trend-legend').attr('transform',(d,i)=>`translate(0, ${i*20})`).style('cursor','pointer').on('click',function(event,d){ const path = svg.selectAll(`[data-item="${d.name}"]`); const current = path.style('opacity') || '1'; const next = current === '0.3' ? '1' : '0.3'; path.style('opacity', next); d3.select(this).classed('hidden', next==='0.3'); });
  legendItems.append('rect').attr('width',15).attr('height',3).attr('y',8.5).attr('fill',d=>d.color);
  legendItems.append('text').attr('x',20).attr('y',10).attr('dy','0.35em').style('font-size','11px').style('fill','#000').text(d=>d.name.length>20?d.name.substring(0,20)+'...':d.name);
}


function randomScore() {
  return +(Math.random() * 6 + 2).toFixed(2); // 2-8 range
}

function generateTestData() {
  // Only initialize datasets that don't exist yet
  if (!DATASETS.Region) {
    DATASETS.Region = [
      'Алматы', 'Астана', 'Шымкент', 'Акмолинская обл.', 'Актюбинская обл.',
      'Алматинская обл.', 'Атырауская обл.', 'ВКО', 'Жамбылская обл.',
      'ЗКО', 'Карагандинская обл.', 'Костанайская обл.', 'Кызылординская обл.',
      'Мангистауская обл.', 'Павлодарская обл.', 'СКО', 'Туркестанская обл.'
    ];
  }

  // Real regional data by year (2020-2024)
  DATASETS.Region = {
  '2020': [
    { id: 'Region_0', name: 'Акмолинская область', shortName: 'Акмолинская обл.', dims: {
      food_insecurity: 10.0, missed_payments: 6.67, internet_access: 3.67, unmet_healthcare: 0.0,
      clothing_afford: 9.72, internet_use: 8.89, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 6.6, health_index: 7.27, financial_situation: 7.11, housing_quality: 7.48,
      leisure_time: 7.49, life_index: 7.87, living_condition: 7.64, prof_wellbeing: 7.86 }, overallScore:0 },
    { id: 'Region_1', name: 'Актюбинская область', shortName: 'Актюбинская обл.', dims: {
      food_insecurity: 0.77, missed_payments: 6.67, internet_access: 5.71, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 8.89, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 6.6, health_index: 7.37, financial_situation: 6.94, housing_quality: 7.49,
      leisure_time: 7.47, life_index: 7.84, living_condition: 7.59, prof_wellbeing: 7.83 }, overallScore:0 },
    { id: 'Region_2', name: 'Алматинская область', shortName: 'Алматинская обл.', dims: {
      food_insecurity: 5.71, missed_payments: 8.57, internet_access: 8.57, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 10.0, social_afford: 10.0, holiday_afford: 8.57,
      welfare_trend: 6.5, health_index: 7.24, financial_situation: 7.09, housing_quality: 7.37,
      leisure_time: 7.33, life_index: 7.93, living_condition: 7.68, prof_wellbeing: 7.86 }, overallScore:0 },
    { id: 'Region_3', name: 'Атырауская область', shortName: 'Атырауская обл.', dims: {
      food_insecurity: 8.33, missed_payments: 6.67, internet_access: 5.14, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 10.0, social_afford: 10.0, holiday_afford: 6.67,
      welfare_trend: 4.0, health_index: 7.25, financial_situation: 7.13, housing_quality: 7.46,
      leisure_time: 7.59, life_index: 7.76, living_condition: 7.63, prof_wellbeing: 8.0 }, overallScore:0 },
    { id: 'Region_4', name: 'Восточно-Казахстанская область', shortName: 'ВКО', dims: {
      food_insecurity: 7.14, missed_payments: 8.57, internet_access: 4.29, unmet_healthcare: 0.0,
      clothing_afford: 9.99, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 7.4, health_index: 7.28, financial_situation: 7.15, housing_quality: 7.4,
      leisure_time: 7.46, life_index: 7.84, living_condition: 7.71, prof_wellbeing: 7.87 }, overallScore:0 },
    { id: 'Region_5', name: 'г. Алматы', shortName: 'г. Алматы', dims: {
      food_insecurity: 8.57, missed_payments: 8.57, internet_access: 3.67, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 8.57, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 6.8, health_index: 7.25, financial_situation: 7.15, housing_quality: 7.51,
      leisure_time: 7.55, life_index: 7.81, living_condition: 7.69, prof_wellbeing: 7.87 }, overallScore:0 },
    { id: 'Region_6', name: 'г. Астана', shortName: 'г. Астана', dims: {
      food_insecurity: 10.0, missed_payments: 10.0, internet_access: 6.43, unmet_healthcare: 0.0,
      clothing_afford: 9.98, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 5.3, health_index: 7.3, financial_situation: 6.99, housing_quality: 7.45,
      leisure_time: 7.53, life_index: 7.92, living_condition: 7.67, prof_wellbeing: 7.93 }, overallScore:0 },
    { id: 'Region_7', name: 'г. Шымкент', shortName: 'г. Шымкент', dims: {
      food_insecurity: 7.5, missed_payments: 7.5, internet_access: 4.29, unmet_healthcare: 0.0,
      clothing_afford: 9.79, internet_use: 7.5, social_afford: 10.0, holiday_afford: 8.75,
      welfare_trend: 4.5, health_index: 7.17, financial_situation: 7.06, housing_quality: 7.4,
      leisure_time: 7.37, life_index: 7.94, living_condition: 7.54, prof_wellbeing: 7.97 }, overallScore:0 },
    { id: 'Region_8', name: 'Жамбылская область', shortName: 'Жамбылская обл.', dims: {
      food_insecurity: 6.67, missed_payments: 6.67, internet_access: 4.82, unmet_healthcare: 0.0,
      clothing_afford: 9.75, internet_use: 7.78, social_afford: 10.0, holiday_afford: 7.78,
      welfare_trend: 5.5, health_index: 7.2, financial_situation: 7.02, housing_quality: 7.58,
      leisure_time: 7.43, life_index: 7.81, living_condition: 7.56, prof_wellbeing: 7.87 }, overallScore:0 },
    { id: 'Region_9', name: 'Западно - Казахстанская область', shortName: 'ЗКО', dims: {
      food_insecurity: 8.33, missed_payments: 10.0, internet_access: 5.14, unmet_healthcare: 0.0,
      clothing_afford: 9.85, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 5.7, health_index: 7.23, financial_situation: 6.99, housing_quality: 7.44,
      leisure_time: 7.68, life_index: 7.81, living_condition: 7.64, prof_wellbeing: 7.8 }, overallScore:0 },
    { id: 'Region_10', name: 'Карагандинская область', shortName: 'Карагандинская обл.', dims: {
      food_insecurity: 7.14, missed_payments: 10.0, internet_access: 7.35, unmet_healthcare: 0.0,
      clothing_afford: 9.93, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 7.5, health_index: 7.2, financial_situation: 7.02, housing_quality: 7.44,
      leisure_time: 7.37, life_index: 7.77, living_condition: 7.6, prof_wellbeing: 7.9 }, overallScore:0 },
    { id: 'Region_11', name: 'Костанайская область', shortName: 'Костанайская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 10.0, internet_access: 5.51, unmet_healthcare: 0.0,
      clothing_afford: 9.81, internet_use: 8.75, social_afford: 10.0, holiday_afford: 8.75,
      welfare_trend: 6.6, health_index: 7.24, financial_situation: 7.1, housing_quality: 7.39,
      leisure_time: 7.48, life_index: 7.81, living_condition: 7.73, prof_wellbeing: 7.88 }, overallScore:0 },
    { id: 'Region_12', name: 'Кызылординская область', shortName: 'Кызылординская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 6.25, internet_access: 4.82, unmet_healthcare: 0.0,
      clothing_afford: 9.99, internet_use: 7.5, social_afford: 10.0, holiday_afford: 8.75,
      welfare_trend: 5.1, health_index: 7.17, financial_situation: 6.97, housing_quality: 7.48,
      leisure_time: 7.42, life_index: 7.92, living_condition: 7.68, prof_wellbeing: 7.79 }, overallScore:0 },
    { id: 'Region_13', name: 'Мангистауская область', shortName: 'Мангистауская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 7.5, internet_access: 5.51, unmet_healthcare: 0.0,
      clothing_afford: 10.01, internet_use: 7.5, social_afford: 10.0, holiday_afford: 7.5,
      welfare_trend: 4.5, health_index: 7.21, financial_situation: 7.08, housing_quality: 7.35,
      leisure_time: 7.54, life_index: 7.91, living_condition: 7.51, prof_wellbeing: 7.76 }, overallScore:0 },
    { id: 'Region_14', name: 'Павлодарская область', shortName: 'Павлодарская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 7.5, internet_access: 3.21, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 7.5, social_afford: 10.0, holiday_afford: 7.5,
      welfare_trend: 7.0, health_index: 7.15, financial_situation: 6.99, housing_quality: 7.61,
      leisure_time: 7.56, life_index: 7.69, living_condition: 7.65, prof_wellbeing: 7.9 }, overallScore:0 },
    { id: 'Region_15', name: 'Северо-Казахстанская область', shortName: 'СКО', dims: {
      food_insecurity: 7.78, missed_payments: 5.56, internet_access: 4.29, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 8.89, social_afford: 10.0, holiday_afford: 7.78,
      welfare_trend: 5.6, health_index: 7.19, financial_situation: 7.08, housing_quality: 7.48,
      leisure_time: 7.51, life_index: 7.76, living_condition: 7.68, prof_wellbeing: 7.94 }, overallScore:0 },
    { id: 'Region_16', name: 'Туркестанская область', shortName: 'Туркестанская обл.', dims: {
      food_insecurity: 8.89, missed_payments: 5.56, internet_access: 7.35, unmet_healthcare: 0.0,
      clothing_afford: 10.04, internet_use: 8.89, social_afford: 10.0, holiday_afford: 6.67,
      welfare_trend: 4.9, health_index: 7.2, financial_situation: 7.1, housing_quality: 7.48,
      leisure_time: 7.51, life_index: 7.97, living_condition: 7.58, prof_wellbeing: 7.96 }, overallScore:0 }
  ],
  '2021': [
    { id: 'Region_0', name: 'Акмолинская область', shortName: 'Акмолинская обл.', dims: {
      food_insecurity: 10.0, missed_payments: 6.67, internet_access: 3.67, unmet_healthcare: 0.0,
      clothing_afford: 9.72, internet_use: 8.89, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 6.6, health_index: 7.24, financial_situation: 7.01, housing_quality: 7.51,
      leisure_time: 7.4, life_index: 7.87, living_condition: 7.77, prof_wellbeing: 7.74 }, overallScore:0 },
    { id: 'Region_1', name: 'Актюбинская область', shortName: 'Актюбинская обл.', dims: {
      food_insecurity: 0.77, missed_payments: 6.67, internet_access: 5.71, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 8.89, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 6.6, health_index: 7.31, financial_situation: 7.06, housing_quality: 7.49,
      leisure_time: 7.45, life_index: 7.81, living_condition: 7.66, prof_wellbeing: 7.86 }, overallScore:0 },
    { id: 'Region_2', name: 'Алматинская область', shortName: 'Алматинская обл.', dims: {
      food_insecurity: 5.71, missed_payments: 8.57, internet_access: 8.57, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 10.0, social_afford: 10.0, holiday_afford: 8.57,
      welfare_trend: 6.5, health_index: 7.18, financial_situation: 7.09, housing_quality: 7.47,
      leisure_time: 7.46, life_index: 7.84, living_condition: 7.54, prof_wellbeing: 7.73 }, overallScore:0 },
    { id: 'Region_3', name: 'Атырауская область', shortName: 'Атырауская обл.', dims: {
      food_insecurity: 8.33, missed_payments: 6.67, internet_access: 5.14, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 10.0, social_afford: 10.0, holiday_afford: 6.67,
      welfare_trend: 4.0, health_index: 7.27, financial_situation: 7.09, housing_quality: 7.36,
      leisure_time: 7.35, life_index: 7.8, living_condition: 7.54, prof_wellbeing: 7.88 }, overallScore:0 },
    { id: 'Region_4', name: 'Восточно-Казахстанская область', shortName: 'ВКО', dims: {
      food_insecurity: 7.14, missed_payments: 8.57, internet_access: 4.29, unmet_healthcare: 0.0,
      clothing_afford: 9.99, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 7.4, health_index: 7.36, financial_situation: 7.16, housing_quality: 7.42,
      leisure_time: 7.45, life_index: 7.79, living_condition: 7.55, prof_wellbeing: 7.72 }, overallScore:0 },
    { id: 'Region_5', name: 'г. Алматы', shortName: 'г. Алматы', dims: {
      food_insecurity: 8.57, missed_payments: 8.57, internet_access: 3.67, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 8.57, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 6.8, health_index: 7.26, financial_situation: 7.16, housing_quality: 7.36,
      leisure_time: 7.42, life_index: 7.82, living_condition: 7.52, prof_wellbeing: 7.65 }, overallScore:0 },
    { id: 'Region_6', name: 'г. Астана', shortName: 'г. Астана', dims: {
      food_insecurity: 10.0, missed_payments: 10.0, internet_access: 6.43, unmet_healthcare: 0.0,
      clothing_afford: 9.98, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 5.3, health_index: 7.28, financial_situation: 7.09, housing_quality: 7.3,
      leisure_time: 7.42, life_index: 7.81, living_condition: 7.47, prof_wellbeing: 7.56 }, overallScore:0 },
    { id: 'Region_7', name: 'г. Шымкент', shortName: 'г. Шымкент', dims: {
      food_insecurity: 7.5, missed_payments: 7.5, internet_access: 4.29, unmet_healthcare: 0.0,
      clothing_afford: 9.79, internet_use: 7.5, social_afford: 10.0, holiday_afford: 8.75,
      welfare_trend: 4.5, health_index: 7.29, financial_situation: 7.12, housing_quality: 7.26,
      leisure_time: 7.38, life_index: 7.62, living_condition: 7.4, prof_wellbeing: 7.92 }, overallScore:0 },
    { id: 'Region_8', name: 'Жамбылская область', shortName: 'Жамбылская обл.', dims: {
      food_insecurity: 6.67, missed_payments: 6.67, internet_access: 4.82, unmet_healthcare: 0.0,
      clothing_afford: 9.75, internet_use: 7.78, social_afford: 10.0, holiday_afford: 7.78,
      welfare_trend: 5.5, health_index: 7.31, financial_situation: 7.12, housing_quality: 7.53,
      leisure_time: 7.35, life_index: 7.77, living_condition: 7.66, prof_wellbeing: 7.86 }, overallScore:0 },
    { id: 'Region_9', name: 'Западно - Казахстанская область', shortName: 'ЗКО', dims: {
      food_insecurity: 8.33, missed_payments: 10.0, internet_access: 5.14, unmet_healthcare: 0.0,
      clothing_afford: 9.85, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 5.7, health_index: 7.21, financial_situation: 7.06, housing_quality: 7.48,
      leisure_time: 7.43, life_index: 7.89, living_condition: 7.69, prof_wellbeing: 7.77 }, overallScore:0 },
    { id: 'Region_10', name: 'Карагандинская область', shortName: 'Карагандинская обл.', dims: {
      food_insecurity: 7.14, missed_payments: 10.0, internet_access: 7.35, unmet_healthcare: 0.0,
      clothing_afford: 9.93, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 7.5, health_index: 7.3, financial_situation: 7.17, housing_quality: 7.55,
      leisure_time: 7.39, life_index: 7.85, living_condition: 7.73, prof_wellbeing: 7.77 }, overallScore:0 },
    { id: 'Region_11', name: 'Костанайская область', shortName: 'Костанайская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 10.0, internet_access: 5.51, unmet_healthcare: 0.0,
      clothing_afford: 9.81, internet_use: 8.75, social_afford: 10.0, holiday_afford: 8.75,
      welfare_trend: 6.6, health_index: 7.21, financial_situation: 7.17, housing_quality: 7.55,
      leisure_time: 7.4, life_index: 7.9, living_condition: 7.67, prof_wellbeing: 7.81 }, overallScore:0 },
    { id: 'Region_12', name: 'Кызылординская область', shortName: 'Кызылординская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 6.25, internet_access: 4.82, unmet_healthcare: 0.0,
      clothing_afford: 9.99, internet_use: 7.5, social_afford: 10.0, holiday_afford: 8.75,
      welfare_trend: 5.1, health_index: 7.2, financial_situation: 7.22, housing_quality: 7.41,
      leisure_time: 7.35, life_index: 7.89, living_condition: 7.63, prof_wellbeing: 7.87 }, overallScore:0 },
    { id: 'Region_13', name: 'Мангистауская область', shortName: 'Мангистауская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 7.5, internet_access: 5.51, unmet_healthcare: 0.0,
      clothing_afford: 10.01, internet_use: 7.5, social_afford: 10.0, holiday_afford: 7.5,
      welfare_trend: 4.5, health_index: 7.34, financial_situation: 7.06, housing_quality: 7.31,
      leisure_time: 7.44, life_index: 7.86, living_condition: 7.6, prof_wellbeing: 7.87 }, overallScore:0 },
    { id: 'Region_14', name: 'Павлодарская область', shortName: 'Павлодарская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 7.5, internet_access: 3.21, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 7.5, social_afford: 10.0, holiday_afford: 7.5,
      welfare_trend: 7.0, health_index: 7.28, financial_situation: 7.23, housing_quality: 7.43,
      leisure_time: 7.44, life_index: 7.84, living_condition: 7.61, prof_wellbeing: 7.77 }, overallScore:0 },
    { id: 'Region_15', name: 'Северо-Казахстанская область', shortName: 'СКО', dims: {
      food_insecurity: 7.78, missed_payments: 5.56, internet_access: 4.29, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 8.89, social_afford: 10.0, holiday_afford: 7.78,
      welfare_trend: 5.6, health_index: 7.25, financial_situation: 7.22, housing_quality: 7.49,
      leisure_time: 7.44, life_index: 7.82, living_condition: 7.62, prof_wellbeing: 7.83 }, overallScore:0 },
    { id: 'Region_16', name: 'Туркестанская область', shortName: 'Туркестанская обл.', dims: {
      food_insecurity: 8.89, missed_payments: 5.56, internet_access: 7.35, unmet_healthcare: 0.0,
      clothing_afford: 10.04, internet_use: 8.89, social_afford: 10.0, holiday_afford: 6.67,
      welfare_trend: 4.9, health_index: 7.33, financial_situation: 7.22, housing_quality: 7.54,
      leisure_time: 7.45, life_index: 7.77, living_condition: 7.59, prof_wellbeing: 7.89 }, overallScore:0 }
  ],
  '2022': [
    { id: 'Region_0', name: 'Акмолинская область', shortName: 'Акмолинская обл.', dims: {
      food_insecurity: 10.0, missed_payments: 6.67, internet_access: 3.67, unmet_healthcare: 0.0,
      clothing_afford: 9.72, internet_use: 8.89, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 6.6, health_index: 7.32, financial_situation: 6.99, housing_quality: 7.47,
      leisure_time: 7.56, life_index: 7.4, living_condition: 7.58, prof_wellbeing: 7.71 }, overallScore:0 },
    { id: 'Region_1', name: 'Актюбинская область', shortName: 'Актюбинская обл.', dims: {
      food_insecurity: 0.77, missed_payments: 6.67, internet_access: 5.71, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 8.89, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 6.6, health_index: 7.39, financial_situation: 7.11, housing_quality: 7.58,
      leisure_time: 7.43, life_index: 7.48, living_condition: 7.51, prof_wellbeing: 7.83 }, overallScore:0 },
    { id: 'Region_2', name: 'Алматинская область', shortName: 'Алматинская обл.', dims: {
      food_insecurity: 5.71, missed_payments: 8.57, internet_access: 8.57, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 10.0, social_afford: 10.0, holiday_afford: 8.57,
      welfare_trend: 6.5, health_index: 7.15, financial_situation: 7.0, housing_quality: 7.61,
      leisure_time: 7.34, life_index: 7.35, living_condition: 7.61, prof_wellbeing: 7.8 }, overallScore:0 },
    { id: 'Region_3', name: 'Атырауская область', shortName: 'Атырауская обл.', dims: {
      food_insecurity: 8.33, missed_payments: 6.67, internet_access: 5.14, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 10.0, social_afford: 10.0, holiday_afford: 6.67,
      welfare_trend: 4.0, health_index: 7.2, financial_situation: 7.14, housing_quality: 7.53,
      leisure_time: 7.39, life_index: 7.47, living_condition: 7.5, prof_wellbeing: 7.85 }, overallScore:0 },
    { id: 'Region_4', name: 'Восточно-Казахстанская область', shortName: 'ВКО', dims: {
      food_insecurity: 7.14, missed_payments: 8.57, internet_access: 4.29, unmet_healthcare: 0.0,
      clothing_afford: 9.99, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 7.4, health_index: 7.26, financial_situation: 7.06, housing_quality: 7.57,
      leisure_time: 7.33, life_index: 7.56, living_condition: 7.56, prof_wellbeing: 7.87 }, overallScore:0 },
    { id: 'Region_5', name: 'г. Алматы', shortName: 'г. Алматы', dims: {
      food_insecurity: 8.57, missed_payments: 8.57, internet_access: 3.67, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 8.57, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 6.8, health_index: 7.38, financial_situation: 7.2, housing_quality: 7.66,
      leisure_time: 7.56, life_index: 7.59, living_condition: 7.63, prof_wellbeing: 7.83 }, overallScore:0 },
    { id: 'Region_6', name: 'г. Астана', shortName: 'г. Астана', dims: {
      food_insecurity: 10.0, missed_payments: 10.0, internet_access: 6.43, unmet_healthcare: 0.0,
      clothing_afford: 9.98, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 5.3, health_index: 7.31, financial_situation: 7.05, housing_quality: 7.69,
      leisure_time: 7.53, life_index: 7.45, living_condition: 7.58, prof_wellbeing: 7.79 }, overallScore:0 },
    { id: 'Region_7', name: 'г. Шымкент', shortName: 'г. Шымкент', dims: {
      food_insecurity: 7.5, missed_payments: 7.5, internet_access: 4.29, unmet_healthcare: 0.0,
      clothing_afford: 9.79, internet_use: 7.5, social_afford: 10.0, holiday_afford: 8.75,
      welfare_trend: 4.5, health_index: 7.31, financial_situation: 7.05, housing_quality: 7.54,
      leisure_time: 7.33, life_index: 7.62, living_condition: 7.69, prof_wellbeing: 7.87 }, overallScore:0 },
    { id: 'Region_8', name: 'Жамбылская область', shortName: 'Жамбылская обл.', dims: {
      food_insecurity: 6.67, missed_payments: 6.67, internet_access: 4.82, unmet_healthcare: 0.0,
      clothing_afford: 9.75, internet_use: 7.78, social_afford: 10.0, holiday_afford: 7.78,
      welfare_trend: 5.5, health_index: 7.46, financial_situation: 7.03, housing_quality: 7.65,
      leisure_time: 7.4, life_index: 7.48, living_condition: 7.71, prof_wellbeing: 7.87 }, overallScore:0 },
    { id: 'Region_9', name: 'Западно - Казахстанская область', shortName: 'ЗКО', dims: {
      food_insecurity: 8.33, missed_payments: 10.0, internet_access: 5.14, unmet_healthcare: 0.0,
      clothing_afford: 9.85, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 5.7, health_index: 7.31, financial_situation: 6.98, housing_quality: 7.54,
      leisure_time: 7.39, life_index: 7.54, living_condition: 7.6, prof_wellbeing: 7.86 }, overallScore:0 },
    { id: 'Region_10', name: 'Карагандинская область', shortName: 'Карагандинская обл.', dims: {
      food_insecurity: 7.14, missed_payments: 10.0, internet_access: 7.35, unmet_healthcare: 0.0,
      clothing_afford: 9.93, internet_use: 10.0, social_afford: 10.0, holiday_afford: 10.0,
      welfare_trend: 7.5, health_index: 7.27, financial_situation: 7.06, housing_quality: 7.58,
      leisure_time: 7.42, life_index: 7.48, living_condition: 7.61, prof_wellbeing: 7.87 }, overallScore:0 },
    { id: 'Region_11', name: 'Костанайская область', shortName: 'Костанайская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 10.0, internet_access: 5.51, unmet_healthcare: 0.0,
      clothing_afford: 9.81, internet_use: 8.75, social_afford: 10.0, holiday_afford: 8.75,
      welfare_trend: 6.6, health_index: 7.32, financial_situation: 6.99, housing_quality: 7.57,
      leisure_time: 7.51, life_index: 7.47, living_condition: 7.5, prof_wellbeing: 7.77 }, overallScore:0 },
    { id: 'Region_12', name: 'Кызылординская область', shortName: 'Кызылординская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 6.25, internet_access: 4.82, unmet_healthcare: 0.0,
      clothing_afford: 9.99, internet_use: 7.5, social_afford: 10.0, holiday_afford: 8.75,
      welfare_trend: 5.1, health_index: 7.23, financial_situation: 6.95, housing_quality: 7.69,
      leisure_time: 7.4, life_index: 7.44, living_condition: 7.62, prof_wellbeing: 7.81 }, overallScore:0 },
    { id: 'Region_13', name: 'Мангистауская область', shortName: 'Мангистауская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 7.5, internet_access: 5.51, unmet_healthcare: 0.0,
      clothing_afford: 10.01, internet_use: 7.5, social_afford: 10.0, holiday_afford: 7.5,
      welfare_trend: 4.5, health_index: 7.29, financial_situation: 7.13, housing_quality: 7.62,
      leisure_time: 7.42, life_index: 7.47, living_condition: 7.48, prof_wellbeing: 7.97 }, overallScore:0 },
    { id: 'Region_14', name: 'Павлодарская область', shortName: 'Павлодарская обл.', dims: {
      food_insecurity: 7.5, missed_payments: 7.5, internet_access: 3.21, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 7.5, social_afford: 10.0, holiday_afford: 7.5,
      welfare_trend: 7.0, health_index: 7.22, financial_situation: 7.01, housing_quality: 7.61,
      leisure_time: 7.57, life_index: 7.5, living_condition: 7.56, prof_wellbeing: 7.8 }, overallScore:0 },
    { id: 'Region_15', name: 'Северо-Казахстанская область', shortName: 'СКО', dims: {
      food_insecurity: 7.78, missed_payments: 5.56, internet_access: 4.29, unmet_healthcare: 0.0,
      clothing_afford: 10.0, internet_use: 8.89, social_afford: 10.0, holiday_afford: 7.78,
      welfare_trend: 5.6, health_index: 7.39, financial_situation: 7.0, housing_quality: 7.62,
      leisure_time: 7.45, life_index: 7.54, living_condition: 7.61, prof_wellbeing: 7.89 }, overallScore:0 },
    { id: 'Region_16', name: 'Туркестанская область', shortName: 'Туркестанская обл.', dims: {
      food_insecurity: 8.89, missed_payments: 5.56, internet_access: 7.35, unmet_healthcare: 0.0,
      clothing_afford: 10.04, internet_use: 8.89, social_afford: 10.0, holiday_afford: 6.67,
      welfare_trend: 4.9, health_index: 7.28, financial_situation: 7.05, housing_quality: 7.69,
      leisure_time: 7.32, life_index: 7.56, living_condition: 7.55, prof_wellbeing: 7.89 } , overallScore:0 }
  ],
    '2023': [
    { id: 'Region_0', name: 'Абайская область', shortName: 'Абайска обл.', dims: {
      food_insecurity: null, missed_payments: 9.80, internet_access: 10.00, unmet_healthcare: 5.71,
      clothing_afford: 9.89, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.29, financial_situation: 7.29, housing_quality: 7.58,
      leisure_time: 7.29, life_index: 7.57, living_condition: 7.64, prof_wellbeing: 7.89 }, overallScore:0 },
    { id: 'Region_1', name: 'Акмолинская область', shortName: 'Акмолинская обл.', dims: {
      food_insecurity: null, missed_payments: 7.14, internet_access: 10.00, unmet_healthcare: 10.00,
      clothing_afford: 9.83, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.31, financial_situation: 7.12, housing_quality: 7.59,
      leisure_time: 7.43, life_index: 7.61, living_condition: 7.74, prof_wellbeing: 7.74 }, overallScore:0 },
    { id: 'Region_2', name: 'Актюбинская область', shortName: 'Актюбинская обл.', dims: {
      food_insecurity: null, missed_payments: 8.57, internet_access: 10.00, unmet_healthcare: 6.25,
      clothing_afford: 9.57, internet_use: 8.75, social_afford: 10.00, holiday_afford: 8.75,
      welfare_trend: null, health_index: 7.30, financial_situation: 7.12, housing_quality: 7.62,
      leisure_time: 7.33, life_index: 7.58, living_condition: 7.63, prof_wellbeing: 7.75 }, overallScore:0 },
    { id: 'Region_3', name: 'Алматинская область', shortName: 'Алматинская обл.', dims: {
      food_insecurity: null, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: 8.00,
      clothing_afford: 10.09, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.38, financial_situation: 7.17, housing_quality: 7.65,
      leisure_time: 7.39, life_index: 7.56, living_condition: 7.61, prof_wellbeing: 7.81 }, overallScore:0 },
    { id: 'Region_4', name: 'Атырауская область', shortName: 'Атырауская обл.', dims: {
      food_insecurity: null, missed_payments: 9.80, internet_access: 10.00, unmet_healthcare: 8.57,
      clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.38, financial_situation: 6.99, housing_quality: 7.62,
      leisure_time: 7.49, life_index: 7.63, living_condition: 7.67, prof_wellbeing: 7.84 }, overallScore:0 },
    { id: 'Region_5', name: 'Восточно-Казахстанская область', shortName: 'ВКО', dims: {
      food_insecurity: null, missed_payments: 8.16, internet_access: 8.57, unmet_healthcare: 7.14,
      clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.30, financial_situation: 7.06, housing_quality: 7.57,
      leisure_time: 7.53, life_index: 7.54, living_condition: 7.68, prof_wellbeing: 7.86 }, overallScore:0 },
    { id: 'Region_6', name: 'г. Алматы', shortName: 'г. Алматы', dims: {
      food_insecurity: null, missed_payments: 9.80, internet_access: 10.00, unmet_healthcare: 8.57,
      clothing_afford: 9.97, internet_use: 10.00, social_afford: 10.00, holiday_afford: 8.57,
      welfare_trend: null, health_index: 7.37, financial_situation: 7.08, housing_quality: 7.57,
      leisure_time: 7.65, life_index: 7.53, living_condition: 7.68, prof_wellbeing: 7.75 }, overallScore:0 },
    { id: 'Region_7', name: 'г. Астана', shortName: 'г. Астана', dims: {
      food_insecurity: null, missed_payments: 8.16, internet_access: 10.00, unmet_healthcare: 7.14,
      clothing_afford: 10.08, internet_use: 10.00, social_afford: 8.57, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.30, financial_situation: 7.01, housing_quality: 7.58,
      leisure_time: 7.43, life_index: 7.52, living_condition: 7.55, prof_wellbeing: 7.87 }, overallScore:0 },
    { id: 'Region_8', name: 'г. Шымкент', shortName: 'г. Шымкент', dims: {
      food_insecurity: null, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: 6.67,
      clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.25, financial_situation: 7.12, housing_quality: 7.58,
      leisure_time: 7.38, life_index: 7.48, living_condition: 7.62, prof_wellbeing: 7.78 }, overallScore:0 },
    { id: 'Region_9', name: 'Жамбылская область', shortName: 'Жамбылская обл.', dims: {
      food_insecurity: null, missed_payments: 8.16, internet_access: 8.57, unmet_healthcare: 7.14,
      clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.33, financial_situation: 7.13, housing_quality: 7.63,
      leisure_time: 7.39, life_index: 7.51, living_condition: 7.59, prof_wellbeing: 7.85 }, overallScore:0 },
    { id: 'Region_10', name: 'Жетісу область', shortName: 'Жетісу обл.', dims: {
      food_insecurity: null, missed_payments: null, internet_access: null, unmet_healthcare: null,
      clothing_afford: null, internet_use: null, social_afford: null, holiday_afford: null,
      welfare_trend: null, health_index: 7.36, financial_situation: 7.33, housing_quality: 7.52,
      leisure_time: 7.48, life_index: 7.54, living_condition: 7.60, prof_wellbeing: 7.78 }, overallScore:0 },
    { id: 'Region_11', name: 'Западно - Казахстанская область', shortName: 'ЗКО', dims: {
      food_insecurity: null, missed_payments: 6.53, internet_access: 10.00, unmet_healthcare: 8.57,
      clothing_afford: 9.92, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.42, financial_situation: 7.14, housing_quality: 7.44,
      leisure_time: 7.47, life_index: 7.54, living_condition: 7.60, prof_wellbeing: 7.84 }, overallScore:0 },
    { id: 'Region_12', name: 'Карагандинская область', shortName: 'Карагандинская обл.', dims: {
      food_insecurity: null, missed_payments: 8.16, internet_access: 8.57, unmet_healthcare: 8.57,
      clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.27, financial_situation: 7.25, housing_quality: 7.45,
      leisure_time: 7.43, life_index: 7.59, living_condition: 7.63, prof_wellbeing: 7.82 }, overallScore:0 },
    { id: 'Region_13', name: 'Костанайская область', shortName: 'Костанайская обл.', dims: {
      food_insecurity: null, missed_payments: 9.52, internet_access: 10.00, unmet_healthcare: 8.33,
      clothing_afford: 9.90, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.31, financial_situation: 7.12, housing_quality: 7.59,
      leisure_time: 7.42, life_index: 7.54, living_condition: 7.67, prof_wellbeing: 7.81 }, overallScore:0 },
    { id: 'Region_14', name: 'Кызылординская область', shortName: 'Кызылординская обл.', dims: {
      food_insecurity: null, missed_payments: 6.53, internet_access: 10.00, unmet_healthcare: 5.71,
      clothing_afford: 10.02, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.35, financial_situation: 7.13, housing_quality: 7.63,
      leisure_time: 7.36, life_index: 7.43, living_condition: 7.57, prof_wellbeing: 7.71 }, overallScore:0 },
    { id: 'Region_15', name: 'Мангистауская область', shortName: 'Мангистауская обл.', dims: {
      food_insecurity: null, missed_payments: 9.52, internet_access: 10.00, unmet_healthcare: 10.00,
      clothing_afford: 10.04, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.23, financial_situation: 7.17, housing_quality: 7.64,
      leisure_time: 7.45, life_index: 7.57, living_condition: 7.70, prof_wellbeing: 7.81 }, overallScore:0 },
    { id: 'Region_16', name: 'Павлодарская область', shortName: 'Павлодарская обл.', dims: {
      food_insecurity: null, missed_payments: 6.53, internet_access: 10.00, unmet_healthcare: 8.57,
      clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.33, financial_situation: 7.14, housing_quality: 7.65,
      leisure_time: 7.45, life_index: 7.50, living_condition: 7.63, prof_wellbeing: 7.77 } , overallScore:0 }
    ],
    '2024': [
    { id: 'Region_0', name: 'Абайская область', shortName: 'Абайска обл.', dims: {
      food_insecurity: null, missed_payments: 6.94, internet_access: 8.75, unmet_healthcare: 8.33,
      clothing_afford: 9.89, internet_use: 8.33, social_afford: 8.75, holiday_afford: 8.33,
      welfare_trend: null, health_index: 7.40, financial_situation: 7.18, housing_quality: 7.69,
      leisure_time: 7.51, life_index: 7.71, living_condition: 7.71, prof_wellbeing: 8.15 }, overallScore:0 },
    { id: 'Region_1', name: 'Акмолинская область', shortName: 'Акмолинская обл.', dims: {
      food_insecurity: null, missed_payments: 7.94, internet_access: 8.57, unmet_healthcare: 9.52,
      clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.35, financial_situation: 7.22, housing_quality: 7.67,
      leisure_time: 7.49, life_index: 7.62, living_condition: 7.61, prof_wellbeing: 8.04 }, overallScore:0 },
    { id: 'Region_2', name: 'Актюбинская область', shortName: 'Актюбинская обл.', dims: {
      food_insecurity: null, missed_payments: 7.94, internet_access: 10.00, unmet_healthcare: 9.52,
      clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.41, financial_situation: 7.22, housing_quality: 7.67,
      leisure_time: 7.40, life_index: 7.57, living_condition: 7.58, prof_wellbeing: 7.88 }, overallScore:0 },
    { id: 'Region_3', name: 'Алматинская область', shortName: 'Алматинская обл.', dims: {
      food_insecurity: null, missed_payments: 6.35, internet_access: 7.14, unmet_healthcare: 6.35,
      clothing_afford: 10.00, internet_use: 8.57, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.41, financial_situation: 7.33, housing_quality: 7.62,
      leisure_time: 7.15, life_index: 7.56, living_condition: 7.53, prof_wellbeing: 7.97 }, overallScore:0 },
    { id: 'Region_4', name: 'Атырауская область', shortName: 'Атырауская обл.', dims: {
      food_insecurity: null, missed_payments: 9.26, internet_access: 10.00, unmet_healthcare: 9.26,
      clothing_afford: 9.96, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.66, financial_situation: 7.24, housing_quality: 7.75,
      leisure_time: 7.37, life_index: 7.66, living_condition: 7.74, prof_wellbeing: 8.13 }, overallScore:0 },
    { id: 'Region_5', name: 'Восточно-Казахстанская область', shortName: 'ВКО', dims: {
      food_insecurity: null, missed_payments: 7.41, internet_access: 10.00, unmet_healthcare: 10.00,
      clothing_afford: 9.79, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.49, financial_situation: 7.23, housing_quality: 7.70,
      leisure_time: 7.49, life_index: 7.73, living_condition: 7.69, prof_wellbeing: 7.78 }, overallScore:0 },
    { id: 'Region_6', name: 'г. Алматы', shortName: 'г. Алматы', dims: {
      food_insecurity: null, missed_payments: 6.94, internet_access: 10.00, unmet_healthcare: 6.94,
      clothing_afford: 10.04, internet_use: 10.00, social_afford: 8.75, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.39, financial_situation: 7.19, housing_quality: 7.65,
      leisure_time: 7.38, life_index: 7.61, living_condition: 7.63, prof_wellbeing: 7.68 }, overallScore:0 },
    { id: 'Region_7', name: 'г. Астана', shortName: 'г. Астана', dims: {
      food_insecurity: null, missed_payments: 9.26, internet_access: 10.00, unmet_healthcare: 10.00,
      clothing_afford: 9.89, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.48, financial_situation: 7.06, housing_quality: 7.53,
      leisure_time: 7.46, life_index: 7.52, living_condition: 7.75, prof_wellbeing: 7.66 }, overallScore:0 },
    { id: 'Region_8', name: 'г. Шымкент', shortName: 'г. Шымкент', dims: {
      food_insecurity: null, missed_payments: 7.94, internet_access: 10.00, unmet_healthcare: 7.94,
      clothing_afford: 9.93, internet_use: 8.57, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.33, financial_situation: 7.26, housing_quality: 7.62,
      leisure_time: 7.56, life_index: 7.66, living_condition: 7.72, prof_wellbeing: 7.73 }, overallScore:0 },
    { id: 'Region_9', name: 'Жамбылская область', shortName: 'Жамбылская обл.', dims: {
      food_insecurity: null, missed_payments: 5.56, internet_access: 10.00, unmet_healthcare: 9.72,
      clothing_afford: 9.86, internet_use: 10.00, social_afford: 10.00, holiday_afford: 9.72,
      welfare_trend: null, health_index: 7.38, financial_situation: 7.28, housing_quality: 7.64,
      leisure_time: 7.39, life_index: 7.65, living_condition: 7.71, prof_wellbeing: 7.83 }, overallScore:0 },
    { id: 'Region_10', name: 'Жетісу область', shortName: 'Жетісу обл.', dims: {
      food_insecurity: null, missed_payments: null, internet_access: null, unmet_healthcare: null,
      clothing_afford: null, internet_use: null, social_afford: null, holiday_afford: null,
      welfare_trend: null, health_index: 7.46, financial_situation: 7.21, housing_quality: 7.54,
      leisure_time: 7.46, life_index: 7.74, living_condition: 7.69, prof_wellbeing: 7.97 }, overallScore:0 },
    { id: 'Region_11', name: 'Западно - Казахстанская область', shortName: 'ЗКО', dims: {
      food_insecurity: null, missed_payments: 9.52, internet_access: 10.00, unmet_healthcare: 7.94,
      clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.41, financial_situation: 7.25, housing_quality: 7.59,
      leisure_time: 7.46, life_index: 7.52, living_condition: 7.67, prof_wellbeing: 7.86 }, overallScore:0 },
    { id: 'Region_12', name: 'Карагандинская область', shortName: 'Карагандинская обл.', dims: {
      food_insecurity: null, missed_payments: 7.94, internet_access: 10.00, unmet_healthcare: 6.35,
      clothing_afford: 9.96, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.45, financial_situation: 7.23, housing_quality: 7.53,
      leisure_time: 7.36, life_index: 7.62, living_condition: 7.64, prof_wellbeing: 7.98 }, overallScore:0 },
    { id: 'Region_13', name: 'Костанайская область', shortName: 'Костанайская обл.', dims: {
      food_insecurity: null, missed_payments: 6.94, internet_access: 10.00, unmet_healthcare: 9.72,
      clothing_afford: 10.09, internet_use: 10.00, social_afford: 10.00, holiday_afford: 9.72,
      welfare_trend: null, health_index: 7.45, financial_situation: 7.28, housing_quality: 7.55,
      leisure_time: 7.39, life_index: 7.65, living_condition: 7.61, prof_wellbeing: 7.85 }, overallScore:0 },
    { id: 'Region_14', name: 'Кызылординская область', shortName: 'Кызылординская обл.', dims: {
      food_insecurity: null, missed_payments: 8.33, internet_access: 10.00, unmet_healthcare: 6.94,
      clothing_afford: 10.08, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.43, financial_situation: 7.19, housing_quality: 7.64,
      leisure_time: 7.45, life_index: 7.58, living_condition: 7.58, prof_wellbeing: 7.94 }, overallScore:0 },
    { id: 'Region_15', name: 'Мангистауская область', shortName: 'Мангистауская обл.', dims: {
      food_insecurity: null, missed_payments: 6.94, internet_access: 10.00, unmet_healthcare: 8.33,
      clothing_afford: 9.98, internet_use: 10.00, social_afford: 10.00, holiday_afford: 8.33,
      welfare_trend: null, health_index: 7.42, financial_situation: 7.19, housing_quality: 7.49,
      leisure_time: 7.40, life_index: 7.59, living_condition: 7.65, prof_wellbeing: 7.91 }, overallScore:0 },
    { id: 'Region_16', name: 'Павлодарская область', shortName: 'Павлодарская обл.', dims: {
      food_insecurity: null, missed_payments: 9.52, internet_access: 10.00, unmet_healthcare: 9.52,
      clothing_afford: 9.92, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
      welfare_trend: null, health_index: 7.50, financial_situation: 7.25, housing_quality: 7.66,
      leisure_time: 7.40, life_index: 7.69, living_condition: 7.67, prof_wellbeing: 7.87 } , overallScore:0 }
    ]
  };

  // If 2023/2024 not filled, copy 2022 as placeholder so regional view shows
  try {
    if ((!DATASETS.Region['2023'] || DATASETS.Region['2023'].length === 0) && DATASETS.Region['2022']) {
      DATASETS.Region['2023'] = JSON.parse(JSON.stringify(DATASETS.Region['2022']));
    }
    if ((!DATASETS.Region['2024'] || DATASETS.Region['2024'].length === 0) && DATASETS.Region['2022']) {
      DATASETS.Region['2024'] = JSON.parse(JSON.stringify(DATASETS.Region['2022']));
    }
  } catch (err) {
    // noop if cloning fails
  }

  // Real age-group data by year
  DATASETS.AgeGroup = {
    '2020': [
      { id: 'Age_0', name: '15–17', shortName: '15–17', dims: {
        food_insecurity: 6.67, missed_payments: 8.33, internet_access: 5.14, unmet_healthcare: null,
        clothing_afford: 9.69, internet_use: 8.33, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 0.38, health_index: 7.28, financial_situation: 6.99, housing_quality: 7.38,
        leisure_time: 7.52, life_index: 7.84, living_condition: 7.59, prof_wellbeing: 7.81 }, overallScore:0 },
      { id: 'Age_1', name: '18–28', shortName: '18–28', dims: {
        food_insecurity: 8.75, missed_payments: 8.75, internet_access: 9.64, unmet_healthcare: null,
        clothing_afford: 9.93, internet_use: 8.75, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 1.20, health_index: 7.25, financial_situation: 7.04, housing_quality: 7.48,
        leisure_time: 7.50, life_index: 7.85, living_condition: 7.58, prof_wellbeing: 7.89 }, overallScore:0 },
      { id: 'Age_2', name: '29–38', shortName: '29–38', dims: {
        food_insecurity: 8.89, missed_payments: 10.00, internet_access: 7.14, unmet_healthcare: null,
        clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 1.90, health_index: 7.27, financial_situation: 7.08, housing_quality: 7.49,
        leisure_time: 7.49, life_index: 7.87, living_condition: 7.65, prof_wellbeing: 7.91 }, overallScore:0 },
      { id: 'Age_3', name: '39–48', shortName: '39–48', dims: {
        food_insecurity: 7.78, missed_payments: 8.89, internet_access: 6.43, unmet_healthcare: null,
        clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 7.78,
        welfare_trend: 1.86, health_index: 7.27, financial_situation: 7.09, housing_quality: 7.45,
        leisure_time: 7.47, life_index: 7.84, living_condition: 7.65, prof_wellbeing: 7.91 }, overallScore:0 },
      { id: 'Age_4', name: '49–57', shortName: '49–57', dims: {
        food_insecurity: 7.78, missed_payments: 7.78, internet_access: 7.14, unmet_healthcare: null,
        clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 1.58, health_index: 7.23, financial_situation: 7.05, housing_quality: 7.61,
        leisure_time: 7.50, life_index: 7.78, living_condition: 7.60, prof_wellbeing: 7.91 }, overallScore:0 },
      { id: 'Age_5', name: '58+', shortName: '58+', dims: {
        food_insecurity: 10.00, missed_payments: 10.00, internet_access: 4.82, unmet_healthcare: null,
        clothing_afford: 9.95, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 3.07, health_index: 7.23, financial_situation: 7.06, housing_quality: 7.49,
        leisure_time: 7.48, life_index: 7.85, living_condition: 7.65, prof_wellbeing: 7.96 }, overallScore:0 }
    ],
    '2021': [
      { id: 'Age_0', name: '15–17', shortName: '15–17', dims: {
        food_insecurity: 8.57, missed_payments: 9.64, internet_access: 9.00, unmet_healthcare: null,
        clothing_afford: 9.90, internet_use: 10.00, social_afford: 10.00, holiday_afford: 8.57,
        welfare_trend: 0.41, health_index: 7.29, financial_situation: 6.90, housing_quality: 7.31,
        leisure_time: 7.29, life_index: 7.86, living_condition: 7.66, prof_wellbeing: 7.56 }, overallScore:0 },
      { id: 'Age_1', name: '18–28', shortName: '18–28', dims: {
        food_insecurity: 10.00, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 9.86, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 1.22, health_index: 7.22, financial_situation: 7.15, housing_quality: 7.44,
        leisure_time: 7.38, life_index: 7.83, living_condition: 7.69, prof_wellbeing: 7.66 }, overallScore:0 },
      { id: 'Age_2', name: '29–38', shortName: '29–38', dims: {
        food_insecurity: 7.14, missed_payments: 8.04, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 2.08, health_index: 7.28, financial_situation: 7.18, housing_quality: 7.46,
        leisure_time: 7.39, life_index: 7.87, living_condition: 7.64, prof_wellbeing: 7.94 }, overallScore:0 },
      { id: 'Age_3', name: '39–48', shortName: '39–48', dims: {
        food_insecurity: 7.50, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 10.00, internet_use: 8.75, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 1.81, health_index: 7.36, financial_situation: 7.20, housing_quality: 7.51,
        leisure_time: 7.40, life_index: 7.83, living_condition: 7.62, prof_wellbeing: 7.85 }, overallScore:0 },
      { id: 'Age_4', name: '49–57', shortName: '49–57', dims: {
        food_insecurity: 8.57, missed_payments: 9.64, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 9.96, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 1.55, health_index: 7.27, financial_situation: 7.15, housing_quality: 7.44,
        leisure_time: 7.44, life_index: 7.79, living_condition: 7.60, prof_wellbeing: 7.77 }, overallScore:0 },
      { id: 'Age_5', name: '58+', shortName: '58+', dims: {
        food_insecurity: 8.75, missed_payments: 10.00, internet_access: 9.00, unmet_healthcare: null,
        clothing_afford: 9.91, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 2.93, health_index: 7.23, financial_situation: 7.08, housing_quality: 7.43,
        leisure_time: 7.45, life_index: 7.79, living_condition: 7.54, prof_wellbeing: 7.79 }, overallScore:0 }
    ],
    '2022': [
      { id: 'Age_0', name: '15–17', shortName: '15–17', dims: {
        food_insecurity: 10.00, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 9.99, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 0.45, health_index: 7.28, financial_situation: 7.16, housing_quality: 7.56,
        leisure_time: 7.32, life_index: 7.51, living_condition: 7.59, prof_wellbeing: 7.82 }, overallScore:0 },
      { id: 'Age_1', name: '18–28', shortName: '18–28', dims: {
        food_insecurity: 8.57, missed_payments: 8.57, internet_access: 7.78, unmet_healthcare: null,
        clothing_afford: 10.00, internet_use: 7.78, social_afford: 10.00, holiday_afford: 8.89,
        welfare_trend: 1.21, health_index: 7.35, financial_situation: 7.06, housing_quality: 7.61,
        leisure_time: 7.45, life_index: 7.52, living_condition: 7.55, prof_wellbeing: 7.89 }, overallScore:0 },
      { id: 'Age_2', name: '29–38', shortName: '29–38', dims: {
        food_insecurity: 10.00, missed_payments: 8.57, internet_access: 8.89, unmet_healthcare: null,
        clothing_afford: 10.04, internet_use: 10.00, social_afford: 8.89, holiday_afford: 10.00,
        welfare_trend: 2.14, health_index: 7.32, financial_situation: 7.01, housing_quality: 7.60,
        leisure_time: 7.41, life_index: 7.47, living_condition: 7.64, prof_wellbeing: 7.87 }, overallScore:0 },
      { id: 'Age_3', name: '39–48', shortName: '39–48', dims: {
        food_insecurity: 9.64, missed_payments: 9.64, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 9.95, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 1.84, health_index: 7.30, financial_situation: 7.09, housing_quality: 7.57,
        leisure_time: 7.37, life_index: 7.52, living_condition: 7.56, prof_wellbeing: 7.83 }, overallScore:0 },
      { id: 'Age_4', name: '49–57', shortName: '49–57', dims: {
        food_insecurity: 9.18, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 9.82, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 1.51, health_index: 7.30, financial_situation: 7.06, housing_quality: 7.61,
        leisure_time: 7.44, life_index: 7.48, living_condition: 7.57, prof_wellbeing: 7.84 }, overallScore:0 },
      { id: 'Age_5', name: '58+', shortName: '58+', dims: {
        food_insecurity: 10.00, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 10.03, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 2.85, health_index: 7.27, financial_situation: 7.03, housing_quality: 7.59,
        leisure_time: 7.52, life_index: 7.49, living_condition: 7.57, prof_wellbeing: 7.74 }, overallScore:0 }
    ],
    '2023': [
      { id: 'Age_0', name: '15–17', shortName: '15–17', dims: {
        food_insecurity: null, missed_payments: 8.16, internet_access: 10.00, unmet_healthcare: 8.57,
        clothing_afford: 9.90, internet_use: 10.00, social_afford: 8.57, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.35, financial_situation: 7.16, housing_quality: 7.51,
        leisure_time: 7.51, life_index: 7.59, living_condition: 7.59, prof_wellbeing: 7.91 }, overallScore:0 },
      { id: 'Age_1', name: '18–28', shortName: '18–28', dims: {
        food_insecurity: null, missed_payments: 8.16, internet_access: 10.00, unmet_healthcare: 10.00,
        clothing_afford: 10.08, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.38, financial_situation: 7.08, housing_quality: 7.61,
        leisure_time: 7.38, life_index: 7.52, living_condition: 7.68, prof_wellbeing: 7.91 }, overallScore:0 },
      { id: 'Age_2', name: '29–38', shortName: '29–38', dims: {
        food_insecurity: null, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: 8.75,
        clothing_afford: 9.92, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.33, financial_situation: 7.10, housing_quality: 7.58,
        leisure_time: 7.43, life_index: 7.50, living_condition: 7.63, prof_wellbeing: 7.78 }, overallScore:0 },
      { id: 'Age_3', name: '39–48', shortName: '39–48', dims: {
        food_insecurity: null, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: 10.00,
        clothing_afford: 9.97, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.33, financial_situation: 7.16, housing_quality: 7.51,
        leisure_time: 7.50, life_index: 7.52, living_condition: 7.59, prof_wellbeing: 7.89 }, overallScore:0 },
      { id: 'Age_4', name: '49–57', shortName: '49–57', dims: {
        food_insecurity: null, missed_payments: 8.57, internet_access: 8.75, unmet_healthcare: 7.50,
        clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.32, financial_situation: 7.16, housing_quality: 7.54,
        leisure_time: 7.40, life_index: 7.58, living_condition: 7.64, prof_wellbeing: 7.76 }, overallScore:0 },
      { id: 'Age_5', name: '58+', shortName: '58+', dims: {
        food_insecurity: null, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: 10.00,
        clothing_afford: 10.07, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.36, financial_situation: 7.15, housing_quality: 7.67,
        leisure_time: 7.45, life_index: 7.57, living_condition: 7.63, prof_wellbeing: 7.87 }, overallScore:0 }
    ],
    '2024': [
      { id: 'Age_0', name: '15–17', shortName: '15–17', dims: {
        food_insecurity: null, missed_payments: 8.33, internet_access: 10.00, unmet_healthcare: 8.33,
        clothing_afford: 10.07, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.45, financial_situation: 7.17, housing_quality: 7.64,
        leisure_time: 7.42, life_index: 7.62, living_condition: 7.67, prof_wellbeing: 8.02 }, overallScore:0 },
      { id: 'Age_1', name: '18–28', shortName: '18–28', dims: {
        food_insecurity: null, missed_payments: 8.33, internet_access: 10.00, unmet_healthcare: 9.72,
        clothing_afford: 10.02, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.41, financial_situation: 7.19, housing_quality: 7.63,
        leisure_time: 7.41, life_index: 7.67, living_condition: 7.67, prof_wellbeing: 7.96 }, overallScore:0 },
      { id: 'Age_2', name: '29–38', shortName: '29–38', dims: {
        food_insecurity: null, missed_payments: 7.94, internet_access: 10.00, unmet_healthcare: 9.52,
        clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.37, financial_situation: 7.20, housing_quality: 7.68,
        leisure_time: 7.44, life_index: 7.60, living_condition: 7.66, prof_wellbeing: 7.94 }, overallScore:0 },
      { id: 'Age_3', name: '39–48', shortName: '39–48', dims: {
        food_insecurity: null, missed_payments: 7.41, internet_access: 10.00, unmet_healthcare: 8.64,
        clothing_afford: 10.03, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.45, financial_situation: 7.23, housing_quality: 7.66,
        leisure_time: 7.38, life_index: 7.62, living_condition: 7.66, prof_wellbeing: 7.93 }, overallScore:0 },
      { id: 'Age_4', name: '49–57', shortName: '49–57', dims: {
        food_insecurity: null, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: 9.52,
        clothing_afford: 9.92, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.42, financial_situation: 7.23, housing_quality: 7.61,
        leisure_time: 7.44, life_index: 7.60, living_condition: 7.74, prof_wellbeing: 7.90 }, overallScore:0 },
      { id: 'Age_5', name: '58+', shortName: '58+', dims: {
        food_insecurity: null, missed_payments: 7.78, internet_access: 10.00, unmet_healthcare: 8.89,
        clothing_afford: 10.00, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.45, financial_situation: 7.24, housing_quality: 7.55,
        leisure_time: 7.44, life_index: 7.68, living_condition: 7.66, prof_wellbeing: 7.87 }, overallScore:0 }
    ]
  };

  // Real gender data by year
  DATASETS.Gender = {
    2020: [
      {
        id: 'Gender_0',
        name: 'Мужчины',
        shortName: 'Мужчины',
        dims: {
          food_insecurity: 10.00,
          missed_payments: 10.00,
          internet_access: 8.50,
          unmet_healthcare: 0.00,
          basic_clothing_afford: 10.00,
          internet_use: 10.00,
          social_afford: 10.00,
          holiday_afford: 10.00,
          welfare_trend: 5.50,
          health_index: 7.20,
          financial_situation: 7.10,
          housing_quality: 7.48,
          leisure_time: 7.48,
          life_index: 7.84,
          living_condition: 7.65,
          prof_wellbeing: 7.89
        },
        overallScore: 0
      },
      {
        id: 'Gender_1',
        name: 'Женщины',
        shortName: 'Женщины',
        dims: {
          food_insecurity: 10.00,
          missed_payments: 8.80,
          internet_access: 7.10,
          unmet_healthcare: 0.00,
          basic_clothing_afford: 9.90,
          internet_use: 10.00,
          social_afford: 10.00,
          holiday_afford: 10.00,
          welfare_trend: 4.50,
          health_index: 7.25,
          financial_situation: 7.03,
          housing_quality: 7.45,
          leisure_time: 7.49,
          life_index: 7.83,
          living_condition: 7.63,
          prof_wellbeing: 7.87
        },
        overallScore: 0
      }
    ],
    2021: [
      {
        id: 'Gender_0',
        name: 'Мужчины',
        shortName: 'Мужчины',
        dims: {
          food_insecurity: 10.0,
          missed_payments: 10.0,
          internet_access: 10.0,
          unmet_healthcare: 0.0,
          basic_clothing_afford: 10.0,
          internet_use: 10.0,
          social_afford: 10.0,
          holiday_afford: 10.0,
          welfare_trend: 5.4,
          health_index: 7.28,
          financial_situation: 7.14,
          housing_quality: 7.49,
          leisure_time: 7.44,
          life_index: 7.79,
          living_condition: 7.62,
          prof_wellbeing: 7.81
        },
        overallScore: 0
      },
      {
        id: 'Gender_1',
        name: 'Женщины',
        shortName: 'Женщины',
        dims: {
          food_insecurity: 8.8,
          missed_payments: 10.0,
          internet_access: 10.0,
          unmet_healthcare: 0.0,
          basic_clothing_afford: 9.9,
          internet_use: 10.0,
          social_afford: 10.0,
          holiday_afford: 10.0,
          welfare_trend: 4.5,
          health_index: 7.26,
          financial_situation: 7.13,
          housing_quality: 7.42,
          leisure_time: 7.39,
          life_index: 7.85,
          living_condition: 7.60,
          prof_wellbeing: 7.77
        },
        overallScore: 0
      }
    ],
    2022: [
      {
        id: 'Gender_0',
        name: 'Мужчины',
        shortName: 'Мужчины',
        dims: {
          food_insecurity: 10.0,
          missed_payments: 10.0,
          internet_access: 8.5,
          unmet_healthcare: 0.0,
          basic_clothing_afford: 10.0,
          internet_use: 10.0,
          social_afford: 10.0,
          holiday_afford: 10.0,
          welfare_trend: 5.5,
          health_index: 7.31,
          financial_situation: 7.08,
          housing_quality: 7.60,
          leisure_time: 7.43,
          life_index: 7.53,
          living_condition: 7.60,
          prof_wellbeing: 7.80
        },
        overallScore: 0
      },
      {
        id: 'Gender_1',
        name: 'Женщины',
        shortName: 'Женщины',
        dims: {
          food_insecurity: 10.0,
          missed_payments: 8.8,
          internet_access: 7.1,
          unmet_healthcare: 0.0,
          basic_clothing_afford: 9.9,
          internet_use: 10.0,
          social_afford: 10.0,
          holiday_afford: 10.0,
          welfare_trend: 4.5,
          health_index: 7.29,
          financial_situation: 7.03,
          housing_quality: 7.59,
          leisure_time: 7.44,
          life_index: 7.47,
          living_condition: 7.57,
          prof_wellbeing: 7.84
        },
        overallScore: 0
      }
    ],
    2023: [
      {
        id: 'Gender_0',
        name: 'Мужчины',
        shortName: 'Мужчины',
        dims: {
          food_insecurity: 0.0,
          missed_payments: 10.0,
          internet_access: 10.0,
          unmet_healthcare: 10.0,
          basic_clothing_afford: 10.0,
          internet_use: 10.0,
          social_afford: 10.0,
          holiday_afford: 10.0,
          welfare_trend: 0.0,
          health_index: 7.30,
          financial_situation: 7.15,
          housing_quality: 7.55,
          leisure_time: 7.42,
          life_index: 7.54,
          living_condition: 7.63,
          prof_wellbeing: 7.80
        },
        overallScore: 0
      },
      {
        id: 'Gender_1',
        name: 'Женщины',
        shortName: 'Женщины',
        dims: {
          food_insecurity: 0.0,
          missed_payments: 10.0,
          internet_access: 10.0,
          unmet_healthcare: 8.7,
          basic_clothing_afford: 9.9,
          internet_use: 10.0,
          social_afford: 10.0,
          holiday_afford: 10.0,
          welfare_trend: 0.0,
          health_index: 7.33,
          financial_situation: 7.13,
          housing_quality: 7.61,
          leisure_time: 7.46,
          life_index: 7.55,
          living_condition: 7.64,
          prof_wellbeing: 7.79
        },
        overallScore: 0
      }
    ],
    2024: [
      {
        id: 'Gender_0',
        name: 'Мужчины',
        shortName: 'Мужчины',
        dims: {
          food_insecurity: 10.0,
          missed_payments: 8.6,
          internet_access: 8.5,
          unmet_healthcare: 10.0,
          basic_clothing_afford: 9.9,
          internet_use: 10.0,
          social_afford: 10.0,
          holiday_afford: 10.0,
          welfare_trend: 0.0,
          health_index: 7.41,
          financial_situation: 7.23,
          housing_quality: 7.65,
          leisure_time: 7.41,
          life_index: 7.65,
          living_condition: 7.66,
          prof_wellbeing: 7.86
        },
        overallScore: 0
      },
      {
        id: 'Gender_1',
        name: 'Женщины',
        shortName: 'Женщины',
        dims: {
          food_insecurity: 10.0,
          missed_payments: 10.0,
          internet_access: 7.1,
          unmet_healthcare: 8.8,
          basic_clothing_afford: 10.0,
          internet_use: 10.0,
          social_afford: 10.0,
          holiday_afford: 10.0,
          welfare_trend: 0.0,
          health_index: 7.44,
          financial_situation: 7.21,
          housing_quality: 7.60,
          leisure_time: 7.43,
          life_index: 7.63,
          living_condition: 7.64,
          prof_wellbeing: 7.91
        },
        overallScore: 0
      }
    ]
  };

  // Real settlement-type data by year (Город / Село)
  DATASETS.SettlementType = {
    '2020': [
      { id: 'Set_0', name: 'Город', shortName: 'Город', dims: {
        food_insecurity: 10.00, missed_payments: 10.00, internet_access: 8.57, unmet_healthcare: null,
        clothing_afford: 10.02, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 5.47, health_index: 7.24, financial_situation: 7.04, housing_quality: 7.46,
        leisure_time: 7.51, life_index: 7.83, living_condition: 7.64, prof_wellbeing: 7.87 }, overallScore:0 },
      { id: 'Set_1', name: 'Село', shortName: 'Село', dims: {
        food_insecurity: 10.00, missed_payments: 8.89, internet_access: 7.14, unmet_healthcare: null,
        clothing_afford: 9.98, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 4.53, health_index: 7.22, financial_situation: 7.08, housing_quality: 7.46,
        leisure_time: 7.46, life_index: 7.84, living_condition: 7.64, prof_wellbeing: 7.90 }, overallScore:0 }
    ],
    '2021': [
      { id: 'Set_0', name: 'Город', shortName: 'Город', dims: {
        food_insecurity: 10.00, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 10.01, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 5.44, health_index: 7.26, financial_situation: 7.07, housing_quality: 7.34,
        leisure_time: 7.40, life_index: 7.78, living_condition: 7.59, prof_wellbeing: 7.73 }, overallScore:0 },
      { id: 'Set_1', name: 'Село', shortName: 'Село', dims: {
        food_insecurity: 8.89, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 9.98, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 4.56, health_index: 7.28, financial_situation: 7.21, housing_quality: 7.58,
        leisure_time: 7.43, life_index: 7.88, living_condition: 7.63, prof_wellbeing: 7.85 }, overallScore:0 }
    ],
    '2022': [
      { id: 'Set_0', name: 'Город', shortName: 'Город', dims: {
        food_insecurity: 10.00, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 10.01, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 5.48, health_index: 7.32, financial_situation: 6.99, housing_quality: 7.59,
        leisure_time: 7.45, life_index: 7.48, living_condition: 7.57, prof_wellbeing: 7.81 }, overallScore:0 },
      { id: 'Set_1', name: 'Село', shortName: 'Село', dims: {
        food_insecurity: 10.00, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: null,
        clothing_afford: 9.98, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: 4.52, health_index: 7.28, financial_situation: 7.12, housing_quality: 7.60,
        leisure_time: 7.43, life_index: 7.51, living_condition: 7.59, prof_wellbeing: 7.85 }, overallScore:0 }
    ],
    '2023': [
      { id: 'Set_0', name: 'Город', shortName: 'Город', dims: {
        food_insecurity: null, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: 8.75,
        clothing_afford: 9.97, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.33, financial_situation: 7.15, housing_quality: 7.62,
        leisure_time: 7.45, life_index: 7.55, living_condition: 7.64, prof_wellbeing: 7.79 }, overallScore:0 },
      { id: 'Set_1', name: 'Село', shortName: 'Село', dims: {
        food_insecurity: null, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: 10.00,
        clothing_afford: 10.03, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.31, financial_situation: 7.12, housing_quality: 7.55,
        leisure_time: 7.44, life_index: 7.53, living_condition: 7.63, prof_wellbeing: 7.80 }, overallScore:0 }
    ],
    '2024': [
      { id: 'Set_0', name: 'Город', shortName: 'Город', dims: {
        food_insecurity: null, missed_payments: 8.64, internet_access: 10.00, unmet_healthcare: 10.00,
        clothing_afford: 9.98, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.43, financial_situation: 7.22, housing_quality: 7.59,
        leisure_time: 7.42, life_index: 7.63, living_condition: 7.66, prof_wellbeing: 7.87 }, overallScore:0 },
      { id: 'Set_1', name: 'Село', shortName: 'Село', dims: {
        food_insecurity: null, missed_payments: 10.00, internet_access: 10.00, unmet_healthcare: 8.89,
        clothing_afford: 10.03, internet_use: 10.00, social_afford: 10.00, holiday_afford: 10.00,
        welfare_trend: null, health_index: 7.42, financial_situation: 7.21, housing_quality: 7.66,
        leisure_time: 7.43, life_index: 7.64, living_condition: 7.64, prof_wellbeing: 7.91 }, overallScore:0 }
    ]
  };

  DATASETS.Year = ['2020', '2021', '2022', '2023', '2024'].map((name, i) => {
    const dims = {};
    DIMENSIONS.forEach(dim => { dims[dim.key] = randomScore(); });
    return {
      id: 'Year_' + i,
      name,
      shortName: name,
      dims,
      satisfaction: +(Math.random() * 3 + 5).toFixed(2),
      overallScore: 0
    };
  });
}

function updateViewTitle() {
  const map = {
    Region: 'Сравнение регионов Казахстана',
    AgeGroup: 'Сравнение возрастных групп',
    Gender: 'Сравнение по полу',
    SettlementType: 'Сравнение типов поселения',
    // Year moved to independent selector
  };
  let title = map[currentGrouping] || 'Сравнение';
  if (selectedYear) title += ' — ' + selectedYear;
  document.getElementById('viewTitle').textContent = title;
}

// Helper: get data for a grouping and year, with simple fallback to nearest available year
function getYearData(group, year) {
  if (!group || !year) return [];
  const set = DATASETS[group];
  if (!set) return [];

  // For year-keyed datasets (Region, Gender, AgeGroup, SettlementType)
  if (typeof set === 'object' && !Array.isArray(set)) {
    // Try direct year access first
    if (set[year] && Array.isArray(set[year])) {
      return set[year];
    }
    // If not found, try to find nearest previous year
    const years = Object.keys(set).sort((a, b) => Number(b) - Number(a)); // Sort descending
    const targetYear = Number(year);
    const nearestYear = years.find(y => Number(y) <= targetYear);
    if (nearestYear) {
      return set[nearestYear];
    }
    return [];
  }
  
  // For simple arrays (legacy support)
  if (Array.isArray(set)) {
    return set;
  }
  
  return [];
}

function overallScore(item) {
  let num = 0, den = 0;
  DIMENSIONS.forEach(dim => {
    const w = weights[dim.key];
    const s = item.dims[dim.key];
    if (s != null && !isNaN(s)) {
      num += s * w;
      den += w;
    }
  });
  return den === 0 ? 0 : +(num / den).toFixed(2);
}

function getCenterRadius(score) {
  return 10 + score * 1.5; // 10px base + score-based increase
}

function radiusFor(dimKey, item) {
  const raw = item.dims[dimKey];
  const w = weights[dimKey];
  const eff = (raw * w) / 10;
  const PETAL_BASE_RADIUS = 60; // slightly reduced to account for center circle
  return (eff / 10) * (PETAL_BASE_RADIUS * 2.0);
}

function petalPolygon(dimIndex, r, centerR) {
  const total = DIMENSIONS.length;
  const ANGLE_SPREAD = 0.25; // slightly reduced spread
  const angleCenter = (2 * Math.PI * dimIndex) / total - Math.PI / 2;
  const a1 = angleCenter - ANGLE_SPREAD;
  const a2 = angleCenter + ANGLE_SPREAD;
  const rTip = r + centerR; // add center radius to total length
  const rSide = centerR + (r * 0.45); // start from center circle
  
  return [
    [Math.cos(angleCenter) * centerR, Math.sin(angleCenter) * centerR], // start at circle edge
    [Math.cos(a1) * rSide, Math.sin(a1) * rSide],
    [Math.cos(angleCenter) * rTip, Math.sin(angleCenter) * rTip],
    [Math.cos(a2) * rSide, Math.sin(a2) * rSide],
    [Math.cos(angleCenter) * centerR, Math.sin(angleCenter) * centerR] // end at circle edge
  ];
}

function sortData(arr) {
  const mode = document.getElementById("sortSelect").value;
  // Create a copy to avoid modifying the input array
  const sorted = arr.slice();
  
  if (mode === "name") {
    sorted.sort((a, b) => d3.ascending(a.name, b.name));
  } else if (mode === "score_desc") {
    sorted.sort((a, b) => d3.descending(a.overallScore, b.overallScore));
  } else if (mode === "score_asc") {
    sorted.sort((a, b) => d3.ascending(a.overallScore, b.overallScore));
  }
  return sorted;
}

function getXScale(data) {
  const pad = (currentGrouping === 'Region') ? 1.2 : 0.5;
  return d3.scalePoint()
    .domain(data.map(d => d.name))
    .range([PAD_LEFT, WIDTH - PAD_RIGHT])
    .padding(pad);
}

// Перенаправляем вызовы в detailCard.js
function showDetailCard(item, clientX, clientY) {
  if (typeof window.showDetailCard === 'function') {
    window.showDetailCard(item, clientX, clientY, DIMENSIONS, colorForDim);
  }
  
  const rect = card.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  // Determine if we should show the card on the left or right of the cursor
  let left = clientX + 15;
  if (left + rect.width > viewportWidth - 20) {
    left = clientX - rect.width - 15;
  }
  
  // Calculate vertical position
  let top = clientY - (rect.height / 2);
  // Ensure the card stays within the viewport vertically
  if (top < 20) {
    top = 20;
  } else if (top + rect.height > viewportHeight - 20) {
    top = viewportHeight - rect.height - 20;
  }
  
  // Apply the position and make visible
  card.style.left = left + 'px';
  card.style.top = top + 'px';
  card.style.visibility = 'visible';
}

function hideDetailCard() {
  document.getElementById('detailCard').style.display = 'none';
}

function updateAll() {
  // Calculate overall scores
  CURRENT_DATA.forEach(d => { d.overallScore = overallScore(d); });
  
  // Create a copy for manipulation
  let displayData = CURRENT_DATA.slice();
  
  // Apply Top-N filter first (always by overall score)
  const topSel = document.getElementById('topSelect') ? document.getElementById('topSelect').value : 'all';
  if (topSel && topSel !== 'all') {
    const n = parseInt(topSel, 10) || displayData.length;
    // Sort by score, take top N
    displayData = displayData.sort((a,b) => d3.descending(a.overallScore, b.overallScore)).slice(0, n);
  }
  
  // Then apply the user's chosen sort order
  sortData(displayData);

  // Update display data with sorted version
  displayData = sortData(displayData);

  const scores = displayData.map(d => d.overallScore || 0);
  const minS = d3.min(scores) || 0;
  const maxS = d3.max(scores) || 10;
  const yMin = Math.max(0, minS - 0.5);
  const yMax = Math.min(10, maxS + 0.5);
  const yLocal = d3.scaleLinear().domain([yMin, yMax]).range([HEIGHT - PAD_BOTTOM, PAD_TOP]);
  const xScale = getXScale(displayData);

  const stems = svg.selectAll(".stem-group").data(displayData, d => d.id);

  const stemsEnter = stems.enter().append("g").attr("class", "stem-group");
  stemsEnter.append("line").attr("class", "axis-line stem-line");
  stemsEnter.append("text").attr("class", "stem-label").attr("transform", "rotate(-90)");
  stemsEnter.append("g").attr("class", "flower-group");

  const stemsMerge = stemsEnter.merge(stems);

  stemsMerge.select(".stem-line")
    .attr("x1", d => xScale(d.name))
    .attr("x2", d => xScale(d.name))
    .attr("y1", PAD_TOP)
    .attr("y2", HEIGHT - PAD_BOTTOM);

  stemsMerge.select(".stem-label")
    .text(d => d.shortName || d.name)
    .attr("x", d => -(HEIGHT - PAD_BOTTOM - 10))
    .attr("y", d => xScale(d.name));

  // ensure stem labels are black
  stemsMerge.select(".stem-label").attr('fill', '#000');

  // Setup gradient definition if not exists
  const defs = svg.selectAll("defs").data([0]).join("defs");
  const gradient = defs.selectAll("#petalGradient").data([0])
    .join("linearGradient")
    .attr("id", "petalGradient")
    .attr("gradientUnits", "userSpaceOnUse");

  gradient.selectAll("stop").data([
    {offset: "0%", color: "#FDE68A"},
    {offset: "100%", color: "#FACC15"}
  ]).join("stop")
    .attr("offset", d => d.offset)
    .attr("stop-color", d => d.color);

  stemsMerge.each(function(item) {
    const gFlower = d3.select(this).select(".flower-group");
    const fx = xScale(item.name);
    const fy = yLocal(item.overallScore);

    gFlower.transition().duration(200).attr("transform", `translate(${fx},${fy})`);

    // Add or update center circle
    const centerR = getCenterRadius(item.overallScore);
    const centerCircle = gFlower.selectAll(".flower-center").data([item]);
    
    centerCircle.enter()
      .append("circle")
      .attr("class", "flower-center")
      .merge(centerCircle)
      .attr("r", centerR)
      .attr("fill", d => colorScaleYellow(d.overallScore))
      .attr("stroke", "#000000") // Black border for contrast
      .attr("stroke-width", 1.5)
      .attr("stroke-opacity", 0.3);

    // Update petals: include index so each dimension gets its own color
    const petals = gFlower.selectAll(".petal").data(
      DIMENSIONS.map((dim, i) => ({
        idx: i,
        key: dim.key,
        poly: petalPolygon(i, radiusFor(dim.key, item), centerR)
      })),
      (d) => d.idx
    );

    petals.enter()
      .append("path")
      .attr("class", "petal")
      .merge(petals)
      .transition()
      .duration(200)
      .attr("d", d => d3.line()(d.poly))
      .attr("fill", d => colorForDim(d.idx));

    petals.exit().remove();

    // Update score text
    const scoreText = gFlower.selectAll(".score-text").data([item]);
    scoreText.enter()
      .append("text")
      .attr("class", "score-text")
      .attr("text-anchor", "middle")
      .attr("dy", "0.35em")
      .merge(scoreText)
      .attr('fill', '#000')
      .text(d => d.overallScore.toFixed(2));

    const HIT_RADIUS = 50; // Increased hit area for better interaction
    const hitArea = gFlower.selectAll(".hit-area").data([item]);
    hitArea.enter()
      .append("circle")
      .attr("class", "hit-area")
      .attr("r", HIT_RADIUS)
      .merge(hitArea)
      .on("mousemove", (event) => {
        // Prevent any text selection during hover
        event.preventDefault();
        
        // Update visual states
        svg.selectAll(".flower-group").classed("highlight", false).style("opacity", 0.15);
        gFlower.classed("highlight", true).style("opacity", 1);
        
        // Get correct mouse coordinates
        const mouseX = event.clientX;
        const mouseY = event.clientY;
        
        // Show detail card with slight delay to prevent flickering
        clearTimeout(window._detailCardTimeout);
        window._detailCardTimeout = setTimeout(() => {
          window.showDetailCard(item, mouseX, mouseY, DIMENSIONS, colorForDim);
        }, 50);
      })
      .on("click", (event) => {
        // When clicking on a flower, highlight corresponding trend line
        highlightTrendLine(item.name);
      })
      .on("mouseleave", () => {
        clearTimeout(window._detailCardTimeout);
        svg.selectAll(".flower-group").classed("highlight", false).style("opacity", 1);
        hideDetailCard();
      });
  });

  stems.exit().remove();
}

function initControls() {
  // Create global tooltip element
  if (!document.getElementById('weight-tooltip')) {
    const tooltipDiv = document.createElement('div');
    tooltipDiv.id = 'weight-tooltip';
    tooltipDiv.className = 'weight-tooltip';
    document.body.appendChild(tooltipDiv);
  }

  const slidersContainer = d3.select("#sliders");
  const sliderGroups = slidersContainer.selectAll(".slider-block")
    .data(DIMENSIONS)
    .enter()
    .append("div")
    .attr("class", "slider-block");

  const tooltipTexts = {
    'food_insecurity': 'Отражает способность домохозяйства обеспечивать базовую продовольственную безопасность',
    'missed_payments': 'Позволяет оценить финансовую устойчивость и способность справляться с текущими расходами',
    'internet_access': 'Доступ в интернет для получения информации, образования и участия в цифровой экономике',
    'unmet_healthcare': 'Показывает доступность медицинской помощи и наличие неудовлетворенных потребностей',
    'clothing_afford': 'Указывает на возможность удовлетворять базовые потребности в одежде',
    'internet_use': 'Отражает цифровую включенность и регулярность использования интернета',
    'social_afford': 'Показывает возможность участия в общественной жизни для социальной интеграции',
    'holiday_afford': 'Отражает наличие ресурсов для отдыха и качество жизни',
    'welfare_trend': 'Показывает усредненную динамику изменений уровня благосостояния за 5 лет',
    'health_index': 'Измеряет среднюю самооценку состояния здоровья населения',
    'financial_situation': 'Отражает уровень удовлетворенности финансовым положением',
    'housing_quality': 'Оценивает качество и комфорт жилищных условий',
    'leisure_time': 'Показывает удовлетворенность наличием и качеством свободного времени',
    'life_index': 'Отражает субъективное восприятие общего качества жизни',
    'living_condition': 'Показывает удовлетворенность общими условиями жизни и окружающей средой',
    'prof_wellbeing': 'Отражает удовлетворенность профессиональной деятельностью и навыками'
  };

  // Добавляем обработчики для позиционирования тултипов
  function positionTooltip(event) {
    const tooltip = event.currentTarget.querySelector('.weight-tooltip');
    if (tooltip) {
      const rect = event.currentTarget.getBoundingClientRect();
      tooltip.style.top = rect.top + window.scrollY + 'px';
      tooltip.style.left = rect.right + 20 + 'px'; // 20px отступ от элемента
    }
  }

  const headerRow = sliderGroups.append("div").attr("class", "slider-head");
  const labelDiv = headerRow.append("div")
    .attr("class", "label-container")
    .style("cursor", "help");
    
  labelDiv.append("span")
    .attr("class", "label-text")
    .text(d => d.label)
    .on("mouseenter", function(event, d) {
      const tooltip = document.getElementById('weight-tooltip');
      if (!tooltip) return;
      
      tooltip.textContent = tooltipTexts[d.key] || 'Описание отсутствует';
      tooltip.style.display = 'block';
      
      const rect = event.target.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();
      
      tooltip.style.left = (rect.right + window.pageXOffset + 20) + 'px';
      tooltip.style.top = (rect.top + window.pageYOffset - (tooltipRect.height / 2) + (rect.height / 2)) + 'px';
    })
    .on("mouseleave", function() {
      const tooltip = document.getElementById('weight-tooltip');
      if (tooltip) tooltip.style.display = 'none';
    });
  
  headerRow.append("div").attr("class", "val").text(d => weights[d.key]);

  sliderGroups.append("div")
    .attr("class", "slider-desc")
    .text("Вес показателя (0–10)");

  sliderGroups.append("input")
    .attr("type", "range")
    .attr("min", 0)
    .attr("max", 10)
    .attr("step", 1)
    .attr("value", d => weights[d.key])
    .on("input", function(event, d) {
      weights[d.key] = +this.value;
      d3.select(this.parentNode).select(".slider-head .val").text(this.value);
      updateAll();
      
      // Update trend visualization if it's visible
      if (trendPanelVisible) {
        setTimeout(updateTrendViz, 50);
      }
    });

  document.getElementById("groupSelect").addEventListener("change", (e) => {
    currentGrouping = e.target.value;
    if ((currentGrouping === 'Gender' || currentGrouping === 'Region' || 
         currentGrouping === 'SettlementType' || currentGrouping === 'AgeGroup') && selectedYear) {
      CURRENT_DATA = getYearData(currentGrouping, selectedYear) || [];
    } else {
      CURRENT_DATA = DATASETS[currentGrouping] || [];
    }
    updateViewTitle();
    updateAll();
  });

  // Populate year selector independently
  const yearSelectEl = document.getElementById('yearSelect');
  if (yearSelectEl) {
    // Clear any existing options
    yearSelectEl.innerHTML = '';
    if (Array.isArray(DATASETS.Year)) {
      DATASETS.Year.forEach(y => {
        const opt = document.createElement('option');
        opt.value = y.name;
        opt.textContent = y.name;
        yearSelectEl.appendChild(opt);
      });
      // default to the most recent year that has region or gender data; fall back to last year
      selectedYear = DATASETS.Year[DATASETS.Year.length - 1].name;
      for (let i = DATASETS.Year.length - 1; i >= 0; i--) {
        const y = DATASETS.Year[i].name;
        if ((DATASETS.Region && DATASETS.Region[y] && DATASETS.Region[y].length > 0) ||
            (DATASETS.Gender && DATASETS.Gender[y] && DATASETS.Gender[y].length > 0)) {
          selectedYear = y;
          break;
        }
      }
      yearSelectEl.value = selectedYear;
    }

      yearSelectEl.addEventListener('change', (e) => {
      selectedYear = e.target.value;
      if (currentGrouping === 'Gender' || currentGrouping === 'Region' || 
          currentGrouping === 'SettlementType' || currentGrouping === 'AgeGroup') {
        CURRENT_DATA = getYearData(currentGrouping, selectedYear) || [];
      }
      updateViewTitle();
      updateAll();
    });
  }

  document.getElementById("sortSelect").addEventListener("change", updateAll);
  const topEl = document.getElementById('topSelect');
  if (topEl) {
    topEl.addEventListener('change', () => {
      updateAll();
      // Update trend visualization if it's visible
      if (trendPanelVisible) {
        setTimeout(updateTrendViz, 50);
      }
    });
  }
}

function boot() {
  // Initialize year-based datasets if they don't exist
  if (!DATASETS.Region || !DATASETS.Gender || !DATASETS.AgeGroup || !DATASETS.SettlementType) {
    generateTestData();
  }
  initControls();
  currentGrouping = 'Region';
  if ((currentGrouping === 'Gender' || currentGrouping === 'Region' || 
       currentGrouping === 'SettlementType' || currentGrouping === 'AgeGroup') && selectedYear) {
    CURRENT_DATA = getYearData(currentGrouping, selectedYear) || [];
  } else {
    CURRENT_DATA = DATASETS[currentGrouping] || [];
  }
  updateViewTitle();
  updateAll();
  // Initialize trend panel UI bindings
  if (typeof initializeTrendPanel === 'function') initializeTrendPanel();
  
  // Initialize ranking panel if available
  if (typeof initRankingPanel === 'function') initRankingPanel();
  
  // Update trend panel when grouping changes
  document.getElementById("groupSelect").addEventListener("change", function() {
    if (trendPanelVisible) {
      setTimeout(updateTrendViz, 50);
    }
  });
}

boot();
</script>
<script src="detailCard.js"></script>
<script src="rankingPanel.js"></script>
</body>
</html>